(window.webpackJsonp=window.webpackJsonp||[]).push([[39],{534:function(e,v,s){"use strict";s.r(v);var _=s(2),a=Object(_.a)({},(function(){var e=this,v=e.$createElement,s=e._self._c||v;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[e._v("TIP")]),e._v(" "),s("p",[e._v("好歹也是玩过挺久资源型爬虫的，但是却一篇文章都没有写，也许时间久了就忘了的说，这里将 B 站爬虫程序单独拿出来重新写一遍，并且记录一下探索流程")]),e._v(" "),s("p",[e._v("注：仅限个人学习和研究使用，切勿用于其他用途")])]),e._v(" "),s("ul",[s("li",[e._v("预备知识\n"),s("ul",[s("li",[e._v("Python 基本语法")]),e._v(" "),s("li",[e._v("requests 库的基本使用")])])]),e._v(" "),s("li",[e._v("开发环境\n"),s("ul",[s("li",[s("code",[e._v("python 3.6")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("requests")])])])]),e._v(" "),s("li",[s("code",[e._v("ffmpeg")])]),e._v(" "),s("li",[s("code",[e._v("Chrome")])])])]),e._v(" "),s("li",[s("a",{attrs:{href:"https://github.com/SigureMo/bilili",target:"_blank",rel:"noopener noreferrer"}},[e._v("项目地址"),s("OutboundLink")],1)])]),e._v(" "),s("h2",{attrs:{id:"探索"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#探索"}},[e._v("#")]),e._v(" 探索")]),e._v(" "),s("blockquote",[s("p",[e._v("如果仅仅是使用的话，请跳到"),s("a",{attrs:{href:"#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"}},[e._v("使用方法")])])]),e._v(" "),s("h3",{attrs:{id:"查看-robots-协议"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看-robots-协议"}},[e._v("#")]),e._v(" 查看 Robots 协议")]),e._v(" "),s("p",[e._v("遵守业界规范，首先查看"),s("a",{attrs:{href:"https://www.bilibili.com/robots.txt",target:"_blank",rel:"noopener noreferrer"}},[e._v("其 robots 协议"),s("OutboundLink")],1)]),e._v(" "),s("p",[e._v("可以发现仅有几个 api 是限制使用的，这里先记着，后面看是否会用到它们（并没有）")]),e._v(" "),s("h3",{attrs:{id:"普通视频的爬取"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#普通视频的爬取"}},[e._v("#")]),e._v(" 普通视频的爬取")]),e._v(" "),s("p",[e._v("仔细分析我们可以发现 B 站视频主页主要有两种，一种是普通视频，另一种是番剧，下面分别对这两种视频进行分析爬取")]),e._v(" "),s("p",[e._v("普通视频的 url 如")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("https://www.bilibili.com/video/av6538245\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("在该页面下的"),s("code",[e._v("视频选集")]),e._v("一栏中可以看到视频列表")]),e._v(" "),s("p",[e._v("首先 "),s("code",[e._v("F12")]),e._v(" 打开开发者模式，切换到 "),s("code",[e._v("Network")]),e._v(" 栏下并刷新页面（最好右键刷新按钮"),s("code",[e._v("选择清空缓存并硬性重新加载")]),e._v("），在抓到的包中分别搜索 "),s("code",[e._v(".mp4")]),e._v(" 与 "),s("code",[e._v(".flv")]),e._v(" ，可以搜到类似于如下的 "),s("code",[e._v("url")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("http://upos-hz-mirrorks3u.acgvideo.com/upgcxcode/97/67/10636797/10636797-1-32.flv?e=ig8euxZM... ...\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("搜索其来源，可以得到一个视频 url 获取接口")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("https://api.bilibili.com/x/player/playurl?avid={avid}&cid={cid}&qn={qn}&type=&otype=json\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("也就是说只要有 "),s("code",[e._v("avid")]),e._v(" 、 "),s("code",[e._v("cid")]),e._v(" 以及 "),s("code",[e._v("qn")]),e._v(" 就可以获取视频，通过分析可以得知 "),s("code",[e._v("avid")]),e._v(" 即为主页 url 中尾部数字，而 "),s("code",[e._v("qn")]),e._v(" 代表了清晰度，代码对应情况如下")]),e._v(" "),s("ul",[s("li",[e._v("120: 超清 4K")]),e._v(" "),s("li",[e._v("116: 超清 1080P60")]),e._v(" "),s("li",[e._v("112: 高清 1080P+")]),e._v(" "),s("li",[e._v("80: 高清 1080P")]),e._v(" "),s("li",[e._v("74: 高清 720P60")]),e._v(" "),s("li",[e._v("64: 高清 720P")]),e._v(" "),s("li",[e._v("32: 清晰 480P")]),e._v(" "),s("li",[e._v("16: 流畅 360P")])]),e._v(" "),s("p",[e._v("所以一个视频只需要字段 "),s("code",[e._v("cid")]),e._v(" 就可以解析其地址了，可以很容易找到 "),s("code",[e._v("cid")]),e._v(" 等信息的解析接口")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("https://api.bilibili.com/x/player/pagelist?aid={avid}&jsonp=jsonp\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("这个接口可以得到所有视频的 "),s("code",[e._v("cid")]),e._v(" 以及标题信息，值得注意的是，每个视频其实是分为多个片段的，所以我们需要分别下载各个视频片段，之后使用 "),s("code",[e._v("ffmpeg")]),e._v(" 进行合并")]),e._v(" "),s("h3",{attrs:{id:"番剧的下载"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#番剧的下载"}},[e._v("#")]),e._v(" 番剧的下载")]),e._v(" "),s("p",[e._v("番剧的 url 如")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("https://www.bilibili.com/bangumi/media/md1733\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("同样地，可以搜到视频 url 解析接口为")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("https://api.bilibili.com/pgc/player/web/playurl?avid={avid}&cid={cid}&qn={qn}&ep_id={ep_id}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("而 "),s("code",[e._v("aid")]),e._v(" 与 "),s("code",[e._v("cid")]),e._v(" 的解析接口为（这里 "),s("code",[e._v("aid")]),e._v(" 并不是主页 url 尾部数字，每个视频的 "),s("code",[e._v("aid")]),e._v(" 与 "),s("code",[e._v("cid")]),e._v(" 都是不同的，所以都需要重新解析）")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("https://api.bilibili.com/pgc/web/season/section?season_id={season_id}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("h3",{attrs:{id:"爬虫请求的模拟"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#爬虫请求的模拟"}},[e._v("#")]),e._v(" 爬虫请求的模拟")]),e._v(" "),s("p",[e._v("值得注意的是，B 站视频主页直接爬取是不能获得 HTML 的（返回 403），通过对抓到的 Headers 进行筛选，可以发现以下字段是必须的")]),e._v(" "),s("div",{staticClass:"language-python line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[e._v("headers "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'User-Agent'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.167 Safari/537.36'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'Referer'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'https://www.bilibili.com'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br")])]),s("h2",{attrs:{id:"使用方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用方法"}},[e._v("#")]),e._v(" 使用方法")]),e._v(" "),s("h3",{attrs:{id:"项目下载"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#项目下载"}},[e._v("#")]),e._v(" 项目下载")]),e._v(" "),s("p",[e._v("项目主页下载或者直接"),s("a",{attrs:{href:"https://github.com/SigureMo/bilili/archive/master.zip",target:"_blank",rel:"noopener noreferrer"}},[e._v("点击链接"),s("OutboundLink")],1)]),e._v(" "),s("h3",{attrs:{id:"快速开始"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#快速开始"}},[e._v("#")]),e._v(" 快速开始")]),e._v(" "),s("ul",[s("li",[e._v("普通视频：\n"),s("ul",[s("li",[s("code",[e._v("https://www.bilibili.com/video/avxxxxxx")])]),e._v(" "),s("li",[s("code",[e._v("https://b23.tv/avxxxxxx")])]),e._v(" "),s("li",[s("code",[e._v("https://www.bilibili.com/video/BVxxxxxx")])]),e._v(" "),s("li",[s("code",[e._v("https://b23.tv/BVxxxxxx")])])])]),e._v(" "),s("li",[e._v("番剧视频： "),s("code",[e._v("https://www.bilibili.com/bangumi/media/mdxxxxxx")])])]),e._v(" "),s("p",[e._v("首先要"),s("strong",[e._v("下载 "),s("code",[e._v("ffmpeg")])]),e._v("（"),s("a",{attrs:{href:"https://ffmpeg.org/download.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("下载地址"),s("OutboundLink")],1),e._v("），存放到任意目录下，并将该目录"),s("strong",[e._v("添加到环境变量")]),e._v("（如果是 "),s("code",[e._v("*nix")]),e._v("，可以很方便地通过包管理器一键完成）")]),e._v(" "),s("p",[e._v("之后"),s("strong",[e._v("安装依赖")])]),e._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("pip "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" -r requirements.txt\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("下载的方式很简单，只需要在终端中运行如下命令即可")]),e._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("python bilili.py "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("url"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("需要将 "),s("code",[e._v("<url>")]),e._v(" 替换为前面的视频主页 url")]),e._v(" "),s("h3",{attrs:{id:"更多参数"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#更多参数"}},[e._v("#")]),e._v(" 更多参数")]),e._v(" "),s("p",[s("code",[e._v("bilili")]),e._v(" 还支持很多参数，具体如下")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("-s")]),e._v("/"),s("code",[e._v("--source")]),e._v(" 选择播放源（"),s("code",[e._v("flash")]),e._v(" or "),s("code",[e._v("h5")]),e._v("）")]),e._v(" "),s("li",[s("code",[e._v("-d")]),e._v("/"),s("code",[e._v("--dir")]),e._v(" 指定存储目录，默认为根目录")]),e._v(" "),s("li",[s("code",[e._v("-r")]),e._v("/"),s("code",[e._v("--sharpness")]),e._v(" 指定清晰度，默认为 "),s("code",[e._v("120")]),e._v("，对应关系如下\n"),s("ul",[s("li",[s("code",[e._v("120")]),e._v(" # 超清 4K")]),e._v(" "),s("li",[s("code",[e._v("116")]),e._v(" # 超清 1080P60")]),e._v(" "),s("li",[s("code",[e._v("112")]),e._v(" # 高清 1080P+")]),e._v(" "),s("li",[s("code",[e._v("80")]),e._v(" # 高清 1080P")]),e._v(" "),s("li",[s("code",[e._v("74")]),e._v(" # 高清 720P60")]),e._v(" "),s("li",[s("code",[e._v("64")]),e._v(" # 高清 720P")]),e._v(" "),s("li",[s("code",[e._v("32")]),e._v(" # 清晰 480P")]),e._v(" "),s("li",[s("code",[e._v("16")]),e._v(" # 流畅 360P\n"),s("blockquote",[s("p",[e._v("如果不存在对应清晰度，会自动降低到最接近的清晰度")])])])])]),e._v(" "),s("li",[s("code",[e._v("-t")]),e._v("/"),s("code",[e._v("--num-thread")]),e._v(" 指定最大下载线程数，默认为 30")]),e._v(" "),s("li",[s("code",[e._v("-p")]),e._v("/"),s("code",[e._v("--episodes")]),e._v(" 选集，可通过以下方式进行选择，默认为 all\n"),s("ul",[s("li",[s("code",[e._v("<p1>")]),e._v(" 单独下某一剧集")]),e._v(" "),s("li",[s("code",[e._v("<p1>,<p2>,<p3>,...,<pn>")]),e._v(" 即通过 "),s("code",[e._v(",")]),e._v(" 分割，不要加空格")]),e._v(" "),s("li",[s("code",[e._v("<p_start>~<p_end>")]),e._v(" 即通过 "),s("code",[e._v("~")]),e._v(" 分隔，下载起始到终止的剧集")]),e._v(" "),s("li",[s("code",[e._v("all")]),e._v(" 全部下载")])])]),e._v(" "),s("li",[s("code",[e._v("-w")]),e._v("/"),s("code",[e._v("--overwrite")]),e._v(" 强制覆盖已下载视频")]),e._v(" "),s("li",[s("code",[e._v("-c")]),e._v("/"),s("code",[e._v("--sess-data")]),e._v(" 传入 "),s("code",[e._v("cookies")]),e._v(" 中的 "),s("code",[e._v("SESSDATA")])]),e._v(" "),s("li",[s("code",[e._v("--playlist-type")]),e._v(" 指定播放列表类型，支持 "),s("code",[e._v("dpl")]),e._v(" 和 "),s("code",[e._v("m3u")]),e._v(" ，默认为 "),s("code",[e._v("dpl")]),e._v("，设置为 "),s("code",[e._v("no")]),e._v(" 即不生成播放列表")]),e._v(" "),s("li",[s("code",[e._v("--path-type")]),e._v(" 指定播放列表路径的类型（"),s("code",[e._v("rp")]),e._v("：相对路径，"),s("code",[e._v("ap")]),e._v("：绝对路径），默认为相对路径")]),e._v(" "),s("li",[s("code",[e._v("--ass")]),e._v(" 自动将 "),s("code",[e._v("XML")]),e._v(" 弹幕转换为 "),s("code",[e._v("ASS")]),e._v(" 弹幕")]),e._v(" "),s("li",[s("code",[e._v("--no-block")]),e._v(" 不使用分段下载器")]),e._v(" "),s("li",[s("code",[e._v("--block-size")]),e._v(" 指定分段下载器分块的大小，默认为 64MB")])]),e._v(" "),s("h1",{attrs:{id:"reference"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#reference"}},[e._v("#")]),e._v(" Reference")]),e._v(" "),s("ol",[s("li",[s("a",{attrs:{href:"https://github.com/1033020837/Bilibili",target:"_blank",rel:"noopener noreferrer"}},[e._v("Bilibili 视频爬取"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);v.default=a.exports}}]);