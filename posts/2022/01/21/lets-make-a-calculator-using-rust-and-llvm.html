<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>用 Rust 和 LLVM 写一个计算器吧～ | Notev</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/favicon152.png">
    <link rel="mask-icon" href="/icons/favicon152.png" color="#3eaf7c">
    <link rel="alternate" type="application/rss+xml" href="https://nyakku.moe/rss.xml" title="Notev RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://nyakku.moe/feed.atom" title="Notev Atom Feed">
    <link rel="alternate" type="application/json" href="https://nyakku.moe/feed.json" title="Notev JSON Feed">
    <meta name="description" content="一个小透明的透明世界">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta property="og:url" content="https://nyakku.moe">
    <meta property="og:site_name" content="Notev">
    <meta property="og:image" content="/bg.webp">
    <meta property="og:description" content="一个小透明的透明世界">
    <meta property="og:title" content="Notev">
    <meta name="theme-color" content="#222222">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/favicon144.png">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/assets/css/0.styles.ae4bc851.css" as="style"><link rel="preload" href="/assets/js/app.6ffe9626.js" as="script"><link rel="preload" href="/assets/js/7.f870edc6.js" as="script"><link rel="preload" href="/assets/js/32.4ac19872.js" as="script"><link rel="preload" href="/assets/js/23.f4ab9440.js" as="script"><link rel="prefetch" href="/assets/js/1.e3010140.js"><link rel="prefetch" href="/assets/js/10.ba769f1e.js"><link rel="prefetch" href="/assets/js/12.e6a9d16c.js"><link rel="prefetch" href="/assets/js/13.cbe40062.js"><link rel="prefetch" href="/assets/js/14.de8176b8.js"><link rel="prefetch" href="/assets/js/15.bc180d2d.js"><link rel="prefetch" href="/assets/js/16.77ffbcb1.js"><link rel="prefetch" href="/assets/js/17.a1263238.js"><link rel="prefetch" href="/assets/js/18.ccc050d1.js"><link rel="prefetch" href="/assets/js/19.a175bc31.js"><link rel="prefetch" href="/assets/js/2.da6cc646.js"><link rel="prefetch" href="/assets/js/20.21f2579f.js"><link rel="prefetch" href="/assets/js/21.a45600e0.js"><link rel="prefetch" href="/assets/js/22.51d6df0c.js"><link rel="prefetch" href="/assets/js/24.41e79c9e.js"><link rel="prefetch" href="/assets/js/25.4dc327c4.js"><link rel="prefetch" href="/assets/js/26.219d9641.js"><link rel="prefetch" href="/assets/js/27.b5a79c37.js"><link rel="prefetch" href="/assets/js/28.8ae7e0e6.js"><link rel="prefetch" href="/assets/js/29.64423761.js"><link rel="prefetch" href="/assets/js/3.27a8c8d5.js"><link rel="prefetch" href="/assets/js/30.622bb606.js"><link rel="prefetch" href="/assets/js/31.f41defd2.js"><link rel="prefetch" href="/assets/js/33.0a79b200.js"><link rel="prefetch" href="/assets/js/34.f5dd158b.js"><link rel="prefetch" href="/assets/js/35.6b94bddf.js"><link rel="prefetch" href="/assets/js/36.1e466a55.js"><link rel="prefetch" href="/assets/js/37.01407288.js"><link rel="prefetch" href="/assets/js/38.b3f1fe79.js"><link rel="prefetch" href="/assets/js/39.7290bc98.js"><link rel="prefetch" href="/assets/js/4.41086855.js"><link rel="prefetch" href="/assets/js/40.91deb8af.js"><link rel="prefetch" href="/assets/js/41.ccf520e8.js"><link rel="prefetch" href="/assets/js/42.c7bd3d1a.js"><link rel="prefetch" href="/assets/js/43.3c8f205d.js"><link rel="prefetch" href="/assets/js/44.7ff432ec.js"><link rel="prefetch" href="/assets/js/45.089b4679.js"><link rel="prefetch" href="/assets/js/46.8dd233b3.js"><link rel="prefetch" href="/assets/js/47.a86d6e2d.js"><link rel="prefetch" href="/assets/js/5.ff46fbd2.js"><link rel="prefetch" href="/assets/js/6.309dd07b.js"><link rel="prefetch" href="/assets/js/8.4a2e364b.js"><link rel="prefetch" href="/assets/js/9.e60d35ed.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ae4bc851.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-meteorlxy"><header class="header" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/bg.webp);" data-v-548d63b6><div data-v-2ce53547 data-v-548d63b6><nav class="navbar" data-v-2ce53547><div class="container" data-v-2ce53547><a href="/" class="router-link-active" data-v-2ce53547><span class="navbar-site-name" data-v-2ce53547>
          Notev
        </span></a> <div class="navbar-toggler" data-v-2ce53547><svg class="icon" style="font-size:1.2em;" data-v-2ce53547 data-v-2ce53547><title data-v-2ce53547 data-v-2ce53547>menu</title><use xlink:href="#icon-menu" data-v-2ce53547 data-v-2ce53547></use></svg></div> <div class="navbar-links" data-v-2ce53547><a href="/" class="navbar-link" data-v-2ce53547>
            Home
          </a><a href="/posts/" class="navbar-link router-link-active" data-v-2ce53547>
            Posts
          </a><a href="/friends.html" class="navbar-link" data-v-2ce53547>
            Friends
          </a><a href="/about.html" class="navbar-link" data-v-2ce53547>
            About
          </a><a href="https://github.com/SigureMo/notev" target="_blank" rel="noopener noreferrer" class="navbar-link" data-v-2ce53547><span data-v-2ce53547>GitHub</span> <span data-v-2ce53547><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div></div></nav> <div class="navbar-holder" style="display:none;" data-v-2ce53547></div></div> <div class="banner" data-v-554dc8f4 data-v-548d63b6 data-v-548d63b6><div class="container" data-v-554dc8f4><div class="center" data-v-554dc8f4><h1 data-v-554dc8f4 data-v-548d63b6>
          用 Rust 和 LLVM 写一个计算器吧～
        </h1></div></div></div></header> <div class="container clearfix show-aside" data-v-5e296355 data-v-5e296355><main class="main" data-v-5e296355><div class="post" data-v-5e296355 data-v-5e296355><section class="post-meta main-div" data-v-3c27fa5a><section class="post-date clearfix" data-v-3c27fa5a><span class="create-date" data-v-3c27fa5a>
      发布时间 : 2022-01-21
    </span> <span class="update-date" data-v-3c27fa5a>
      最后修改 : 2023-08-28
    </span></section> <section class="post-links" data-v-3c27fa5a><a href="/posts/2021/02/10/proxy-and-vue3-reactivity.html" class="post-link" data-v-3c27fa5a>
      上一篇 : Proxy 以及 Vue3 中的响应式
    </a> <a href="/posts/2022/09/21/moefy-paddle-dx-improvements.html" class="post-link" data-v-3c27fa5a>
      下一篇 : 让 Paddle 更可爱——开发者体验提升计划
    </a></section></section> <article class="main-div"><div class="post-content content content__default"><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>嘻嘻，因为可能之后要做一些编译相关的东西，所以准备先熟悉一下 LLVM 和 Rust。在 Rust 里有一个比较好用的 Rust 的 safely binding inkwell，在查找 inkwell 的示例时候找到了一个很多功能未完成的 <a href="https://michael-f-bryan.github.io/calc/book/html/intro.html" target="_blank" rel="noopener noreferrer">Rusty Calc<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，因此这次就参考它写一个简简单单的计算器吧～</p></div> <h2 id="做个什么样的计算器呢"><a href="#做个什么样的计算器呢" class="header-anchor">#</a> 做个什么样的计算器呢？</h2> <p>唔，使用编译原理的话写一个计算器实在是太简单了，毕竟计算器只有简简单单的<strong>表达式</strong>，而没有那些复杂的<strong>语句</strong>之类的。虽说简单，但制作一个计算器也是包括了编译的完整流程的，因此拿来练手还是挺合适的～不过重点不是这些，这次我主要的目的是熟悉下 Rust 并了解下 LLVM 的使用方式。</p> <p>那……要做一个什么样的计算器才合适呢？在开始之前我们首先制定一下计划：</p> <ul><li>它可以运算一些数学表达式，它包含一些常用一元和二元运算符，比如 <code>5 * (6 + 7) / -8</code></li> <li>它可以访问一些预定义的常量，比如 <code>2 * PI</code></li> <li>它可以使用一些预定义的函数，比如 <code>log(2, 4)</code></li> <li>我们可以为其自定义变量，不过为了简单，我们不需要从文本中专门增加这样一个语句来实现它，而是通过程序 API 在运算前调用实现，比如 <code>define_variable(&quot;a&quot;, 0.1)</code></li> <li>同样的，我们也可以通过程序里的 API 定义一些函数，比如 <code>define_function(&quot;add&quot;, |x, y| x + y)</code></li></ul> <p>我们可以很轻松写出满足该条件的语法 BNF：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>expr ::= &lt;expr&gt; &quot;+&quot; &lt;term&gt;
      | &lt;expr&gt; &quot;-&quot; &lt;term&gt;
      | &lt;term&gt;
term ::=  &lt;term&gt; &quot;*&quot; &lt;term&gt;
      | &lt;term&gt; &quot;/&quot; &lt;term&gt;
      | &lt;factor-with-unary-op&gt;
factor-with-unary-op ::= &quot;+&quot; &lt;factor-with-unary-op&gt;
                     | &quot;-&quot; &lt;factor-with-unary-op&gt;
                     | &lt;factor-with-unary-op&gt; &quot;!&quot;
                     | &lt;factor&gt;
factor ::= &lt;number&gt;
      | &lt;function-call&gt;
      | &lt;identifier&gt;
      | &quot;(&quot; &lt;expr&gt; &quot;)&quot;
function-call ::= &lt;identifier&gt; &quot;(&quot; &lt;arg-list&gt; &quot;)&quot;
arg-list ::= &lt;empty&gt;
          | &lt;expr&gt; (&quot;,&quot; &lt;expr&gt;)*
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>这里 expr 就是我们的文法开始符号了，也就是说我们只支持表达式，并通过 term 和 factor 确保乘除优先级高于加减法。为了支持最高优先级的各种一元运算符，因此中间插入了一个 factor-with-unary-op。</p> <h2 id="设计一下-ast-结构"><a href="#设计一下-ast-结构" class="header-anchor">#</a> 设计一下 AST 结构</h2> <p>语法已经基本完成，现在我们根据它设计一下 AST 的结构。</p> <h3 id="数字与变量"><a href="#数字与变量" class="header-anchor">#</a> 数字与变量</h3> <p>我们的语法里除了运算符里有两个终结符，分别是 number 和 identifier，我们将它们全放进 Atom 里。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(Debug, PartialEq, Clone)]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Atom</span> <span class="token punctuation">{</span>
    <span class="token class-name">Ident</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Number</span><span class="token punctuation">(</span><span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="运算符"><a href="#运算符" class="header-anchor">#</a> 运算符</h3> <p>我们的 Atom 之间是通过一些运算符结合在一起的，我们将这里的运算符定义为 Op，而结合后的节点定义为 Arithmetic。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(Debug, PartialEq, Clone)]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">BinaryOp</span> <span class="token punctuation">{</span>
    <span class="token class-name">Add</span><span class="token punctuation">,</span>
    <span class="token class-name">Sub</span><span class="token punctuation">,</span>
    <span class="token class-name">Mul</span><span class="token punctuation">,</span>
    <span class="token class-name">Div</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token attribute attr-name">#[derive(Debug, PartialEq, Clone)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">BinaryArithmetic</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> op<span class="token punctuation">:</span> <span class="token class-name">BinaryOp</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> lhs<span class="token punctuation">:</span> <span class="token class-name">Expr</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> rhs<span class="token punctuation">:</span> <span class="token class-name">Expr</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>当然我们既包含一元运算又包含二元运算，但代码基本上是一致的，一元运算就不赘述啦～</p> <h3 id="函数调用"><a href="#函数调用" class="header-anchor">#</a> 函数调用</h3> <p>除去这些，我们还有一个 FunctionCall 结点用于表示函数调用，它包含了函数名和函数参数。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(Debug, PartialEq, Clone)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">FunctionCall</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> args<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Expr</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="表达式结点"><a href="#表达式结点" class="header-anchor">#</a> 表达式结点</h3> <p>当然，最后别忘了我们的顶层表达式结点 Expr</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(Debug, PartialEq, Clone)]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Expr</span> <span class="token punctuation">{</span>
    <span class="token class-name">BinaryArithmetic</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">BinaryArithmetic</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">UnaryArithmetic</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">UnaryArithmetic</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Atom</span><span class="token punctuation">(</span><span class="token class-name">Atom</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">FunctionCall</span><span class="token punctuation">(</span><span class="token class-name">FunctionCall</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>为了方便，我们为各个结点都实现 <code>Into&lt;Expr&gt;</code> 这一 trait，并为需要的结点实现自己的工厂函数 new</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">BinaryArithmetic</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>op<span class="token punctuation">:</span> <span class="token class-name">BinaryOp</span><span class="token punctuation">,</span> lhs<span class="token punctuation">:</span> <span class="token class-name">Expr</span><span class="token punctuation">,</span> rhs<span class="token punctuation">:</span> <span class="token class-name">Expr</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token class-name">BinaryArithmetic</span> <span class="token punctuation">{</span> op<span class="token punctuation">,</span> lhs<span class="token punctuation">,</span> rhs <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> <span class="token class-name">Into</span><span class="token operator">&lt;</span><span class="token class-name">Expr</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">BinaryArithmetic</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">into</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Expr</span> <span class="token punctuation">{</span>
        <span class="token class-name">Expr</span><span class="token punctuation">::</span><span class="token class-name">BinaryArithmetic</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="用-peg-同时完成词法、语法分析"><a href="#用-peg-同时完成词法、语法分析" class="header-anchor">#</a> 用 peg 同时完成词法、语法分析</h2> <p>下面我们便开始编写我们的计算器吧～让我想想，编译需要哪些步骤来着？词法分析、语法分析、语义分析、中间代码生成……啊……虽说手写个递归下降分析器也是分分钟的事，但总归还是麻烦，需要写大量重复的代码。而且手写递归下降的话总归还是要面临左递归和左公共因子，所以文法还是需要稍微修改下，可读性可能会因此而降低许多……</p> <p>嘛，为了解决这些问题，我去找了些 Rust 里的相关 crate，最终决定使用 peg 来做词法、语法分析。</p> <p>至于为什么用 peg 嘛，主要是它可以直接利用宏直接嵌入在代码里，通过宏自动展开成 rust 代码，而不需要额外编译，另外直接嵌入代码带来最大的优势就是可以实时代码高亮和类型提示。再就是由于 peg 以 PEG 方式解析，因此可以在不改变文法的情况下写左递归和含有左公共表达式的文法。</p> <p>让我们对照着之前写的 BNF，写一个 peg 的 parser ～</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token namespace">peg<span class="token punctuation">::</span></span><span class="token macro property">parser!</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> grammar <span class="token function">calc_parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> <span class="token keyword">str</span> <span class="token punctuation">{</span>
        <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token class-name">Expr</span><span class="token punctuation">;</span>
        <span class="token attribute attr-name">#[cache_left_rec]</span>
        <span class="token keyword">pub</span> rule <span class="token function">expr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Expr</span>
            <span class="token operator">=</span> a<span class="token punctuation">:</span><span class="token function">expr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> _ <span class="token string">&quot;+&quot;</span> _ b<span class="token punctuation">:</span><span class="token function">term</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token class-name">BinaryArithmetic</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">BinaryOp</span><span class="token punctuation">::</span><span class="token class-name">Add</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token operator">/</span> a<span class="token punctuation">:</span><span class="token function">expr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> _ <span class="token string">&quot;-&quot;</span> _ b<span class="token punctuation">:</span><span class="token function">term</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token class-name">BinaryArithmetic</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">BinaryOp</span><span class="token punctuation">::</span><span class="token class-name">Sub</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token operator">/</span> <span class="token function">term</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token attribute attr-name">#[cache_left_rec]</span>
        <span class="token keyword">pub</span> rule <span class="token function">term</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Expr</span>
            <span class="token operator">=</span> a<span class="token punctuation">:</span><span class="token function">term</span><span class="token punctuation">(</span><span class="token punctuation">)</span> _ <span class="token string">&quot;*&quot;</span> _ b<span class="token punctuation">:</span><span class="token function">factor_with_unary_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token class-name">BinaryArithmetic</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">BinaryOp</span><span class="token punctuation">::</span><span class="token class-name">Mul</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token operator">/</span> a<span class="token punctuation">:</span><span class="token function">term</span><span class="token punctuation">(</span><span class="token punctuation">)</span> _ <span class="token string">&quot;/&quot;</span> _ b<span class="token punctuation">:</span><span class="token function">factor_with_unary_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token class-name">BinaryArithmetic</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">BinaryOp</span><span class="token punctuation">::</span><span class="token class-name">Div</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token operator">/</span> <span class="token function">factor_with_unary_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token attribute attr-name">#[cache_left_rec]</span>
        <span class="token keyword">pub</span> rule <span class="token function">factor_with_unary_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Expr</span>
            <span class="token operator">=</span> <span class="token string">&quot;+&quot;</span> _ a<span class="token punctuation">:</span><span class="token function">factor_with_unary_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token class-name">UnaryArithmetic</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">UnaryOp</span><span class="token punctuation">::</span><span class="token class-name">Pos</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token operator">/</span> <span class="token string">&quot;-&quot;</span> _ a<span class="token punctuation">:</span><span class="token function">factor_with_unary_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token class-name">UnaryArithmetic</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">UnaryOp</span><span class="token punctuation">::</span><span class="token class-name">Neg</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token operator">/</span> a<span class="token punctuation">:</span><span class="token function">factor_with_unary_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token string">&quot;!&quot;</span> <span class="token punctuation">{</span> <span class="token class-name">UnaryArithmetic</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">UnaryOp</span><span class="token punctuation">::</span><span class="token class-name">Fac</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token operator">/</span> <span class="token function">factor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token attribute attr-name">#[cache]</span>
        <span class="token keyword">pub</span> rule <span class="token function">factor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Expr</span>
            <span class="token operator">=</span> <span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">/</span> <span class="token function">function_call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">/</span> <span class="token function">identifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">/</span> <span class="token string">&quot;(&quot;</span> _ e<span class="token punctuation">:</span><span class="token function">expr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> _ <span class="token string">&quot;)&quot;</span> <span class="token punctuation">{</span> e <span class="token punctuation">}</span>
        <span class="token keyword">pub</span> rule <span class="token function">function_call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Expr</span>
            <span class="token operator">=</span> id<span class="token punctuation">:</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> _ v<span class="token punctuation">:</span><span class="token function">bracketed</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token function">commasep</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token function">expr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">FunctionCall</span><span class="token punctuation">::</span><span class="token function">new</span> <span class="token punctuation">(</span>
                    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Expr</span><span class="token punctuation">::</span><span class="token class-name">Atom</span><span class="token punctuation">(</span><span class="token class-name">Atom</span><span class="token punctuation">::</span><span class="token class-name">Ident</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> id <span class="token punctuation">{</span> x <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">to_owned</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    v
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">pub</span> rule <span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Expr</span>
            <span class="token operator">=</span> n<span class="token punctuation">:</span>$<span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token operator">?</span> <span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span> <span class="token operator">/</span> <span class="token punctuation">[</span><span class="token char">'1'</span><span class="token punctuation">..=</span><span class="token char">'9'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token char">'0'</span><span class="token punctuation">..=</span><span class="token char">'9'</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span> <span class="token punctuation">[</span><span class="token char">'0'</span><span class="token punctuation">..=</span><span class="token char">'9'</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token class-name">Atom</span><span class="token punctuation">::</span><span class="token class-name">Number</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token keyword">pub</span> rule <span class="token function">identifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Expr</span>
            <span class="token operator">=</span> id<span class="token punctuation">:</span>$<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token char">'a'</span><span class="token punctuation">..=</span><span class="token char">'z'</span> <span class="token operator">|</span> <span class="token char">'A'</span><span class="token punctuation">..=</span><span class="token char">'Z'</span> <span class="token operator">|</span> <span class="token char">'_'</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token char">'a'</span><span class="token punctuation">..=</span><span class="token char">'z'</span> <span class="token operator">|</span> <span class="token char">'A'</span><span class="token punctuation">..=</span><span class="token char">'Z'</span> <span class="token operator">|</span> <span class="token char">'0'</span><span class="token punctuation">..=</span><span class="token char">'9'</span> <span class="token operator">|</span> <span class="token char">'_'</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token class-name">Atom</span><span class="token punctuation">::</span><span class="token class-name">Ident</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">to_owned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        rule commasep<span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> rule<span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token operator">=</span> v<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">(</span> _ <span class="token string">&quot;,&quot;</span> _ <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token string">&quot;,&quot;</span><span class="token operator">?</span> <span class="token punctuation">{</span> v <span class="token punctuation">}</span>
        rule bracketed<span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> rule<span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">T</span> <span class="token operator">=</span> <span class="token string">&quot;(&quot;</span> _  v<span class="token punctuation">:</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> _ <span class="token string">&quot;)&quot;</span> <span class="token punctuation">{</span> v <span class="token punctuation">}</span>
        rule _ <span class="token operator">=</span> <span class="token string">&quot; &quot;</span><span class="token operator">*</span>
        rule <span class="token constant">__</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">&quot; &quot;</span> <span class="token operator">/</span> <span class="token string">&quot;\n&quot;</span> <span class="token operator">/</span> <span class="token string">&quot;\r&quot;</span><span class="token punctuation">)</span><span class="token operator">*</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>emm，和原来的 BNF 基本没有区别嘛，也就多了些生成 AST 的代码。</p> <p>这样，我们通过 <code>calc_parser::expr</code> 就可以将字符串解析为一棵 AST 了喔～</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>
   <span class="token namespace">calc_parser<span class="token punctuation">::</span></span><span class="token function">expr</span><span class="token punctuation">(</span><span class="token string">&quot;1 + 9 / 10&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">BinaryArithmetic</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
         <span class="token class-name">BinaryOp</span><span class="token punctuation">::</span><span class="token class-name">Add</span><span class="token punctuation">,</span>
         <span class="token class-name">Atom</span><span class="token punctuation">::</span><span class="token class-name">Number</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token class-name">BinaryArithmetic</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
            <span class="token class-name">BinaryOp</span><span class="token punctuation">::</span><span class="token class-name">Div</span><span class="token punctuation">,</span>
            <span class="token class-name">Atom</span><span class="token punctuation">::</span><span class="token class-name">Number</span><span class="token punctuation">(</span><span class="token number">9</span> <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Atom</span><span class="token punctuation">::</span><span class="token class-name">Number</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">)</span>
   <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="为-ast-实现-visitor"><a href="#为-ast-实现-visitor" class="header-anchor">#</a> 为 AST 实现 visitor</h2> <p>唔，既然已经得到一棵 AST 了，理所当然我们首先会想如何去遍历它，啊……当然遍历方法是递归啦，其实问题是我们如何去组织这个遍历的代码～</p> <p>比如我们稍后对各个结点进行 print、check、compile 等等操作，啊这显而易见嘛，既然大家都需要实现这三个函数，那么我们让他们都实现同一个 trait 就好了，这个 trait 要求所有结点都实现这三个函数就 OK 了。</p> <p><img alt="visitor-01" data-src="/assets/img/visitor-01.drawio.b0c78f2c.png" loading="lazy" class="lazy"></p> <p>emmm，我们最后实现的代码可能会像上图这样。唔，这样做倒确实可以完成我们的需求啦，但是这样做造成了相同逻辑代码分散在不同的结构体中，所以无论是实现新的逻辑还是修改现有逻辑，我们都得同时修改多个文件……</p> <p>所以说这种代码组织方式在这里并不是很合适啦，那我们稍微改一下，把每个逻辑放在一起，我们将每个逻辑的集合体称为 Visitor，它将会实现 visit 各种 Node 的方法。</p> <p><img alt="visitor-02" data-src="/assets/img/visitor-02.drawio.45935487.png" loading="lazy" class="lazy"></p> <p>就像上图这样，我们的代码是不是看起来会好很多呢？</p> <p>那么对于我们的代码，如何实现这样一个 Visitor 也是显而易见了～</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Visitor</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_expr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> e<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Expr</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">T</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_unary</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> u<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">UnaryArithmetic</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">T</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_binary</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">BinaryArithmetic</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">T</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_function</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">FunctionCall</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">T</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_atom</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> a<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Atom</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">T</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>我们实现一个简单的能够帮我们打印树状结构 PrettyPrinter 吧～</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">PrettyPrinter</span> <span class="token punctuation">{</span>
    indent_level<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    indent<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> <span class="token class-name">PrettyPrinter</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>indent<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token class-name">PrettyPrinter</span> <span class="token punctuation">{</span>
            indent_level<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            indent<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">get_indent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">usize</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>indent_level <span class="token operator">*</span> <span class="token keyword">self</span><span class="token punctuation">.</span>indent<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">usize</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> <span class="token class-name">Visitor</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">PrettyPrinter</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_expr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> e<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Expr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> indent <span class="token operator">=</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">get_indent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{indent}Expr&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>indent_level <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">match</span> e <span class="token punctuation">{</span>
            <span class="token class-name">Expr</span><span class="token punctuation">::</span><span class="token class-name">UnaryArithmetic</span><span class="token punctuation">(</span><span class="token keyword">ref</span> u<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_unary</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Expr</span><span class="token punctuation">::</span><span class="token class-name">BinaryArithmetic</span><span class="token punctuation">(</span><span class="token keyword">ref</span> b<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_binary</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Expr</span><span class="token punctuation">::</span><span class="token class-name">FunctionCall</span><span class="token punctuation">(</span><span class="token keyword">ref</span> f<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_function</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Expr</span><span class="token punctuation">::</span><span class="token class-name">Atom</span><span class="token punctuation">(</span><span class="token keyword">ref</span> a<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_atom</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>indent_level <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_unary</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> u<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">UnaryArithmetic</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> indent <span class="token operator">=</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">get_indent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">match</span> u<span class="token punctuation">.</span>op <span class="token punctuation">{</span>
            <span class="token class-name">UnaryOp</span><span class="token punctuation">::</span><span class="token class-name">Pos</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{indent}Pos&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">UnaryOp</span><span class="token punctuation">::</span><span class="token class-name">Neg</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{indent}Neg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">UnaryOp</span><span class="token punctuation">::</span><span class="token class-name">Fac</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{indent}Fac&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{indent}Unary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>indent_level <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_expr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>u<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>indent_level <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_binary</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">BinaryArithmetic</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> indent <span class="token operator">=</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">get_indent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">match</span> b<span class="token punctuation">.</span>op <span class="token punctuation">{</span>
            <span class="token class-name">BinaryOp</span><span class="token punctuation">::</span><span class="token class-name">Add</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{indent}Add&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">BinaryOp</span><span class="token punctuation">::</span><span class="token class-name">Sub</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{indent}Sub&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">BinaryOp</span><span class="token punctuation">::</span><span class="token class-name">Mul</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{indent}Mul&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">BinaryOp</span><span class="token punctuation">::</span><span class="token class-name">Div</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{indent}Div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>indent_level <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_expr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">.</span>lhs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_expr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">.</span>rhs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>indent_level <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_function</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">FunctionCall</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> indent <span class="token operator">=</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">get_indent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> func_name <span class="token operator">=</span> <span class="token operator">&amp;</span>f<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{indent}Function {func_name}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>indent_level <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> arg <span class="token keyword">in</span> <span class="token operator">&amp;</span>f<span class="token punctuation">.</span>args <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_expr</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>indent_level <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_atom</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> a<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Atom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> indent <span class="token operator">=</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">get_indent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">match</span> a <span class="token punctuation">{</span>
            <span class="token class-name">Atom</span><span class="token punctuation">::</span><span class="token class-name">Ident</span><span class="token punctuation">(</span><span class="token keyword">ref</span> id<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{indent}Identifier {id}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Atom</span><span class="token punctuation">::</span><span class="token class-name">Number</span><span class="token punctuation">(</span><span class="token keyword">ref</span> n<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{indent}Number {n}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><p>嗯，就是这么简单啦，这样我们就可以通过 <code>PrettyPrinter::new(2).visit_expr(ast)</code> 来打印一棵 AST 了～</p> <p>当然，我们接下来的 Visitor 和这处理方式很相似，其实我们现在距离结束已经非常近啦～</p> <h2 id="简简单单解释器"><a href="#简简单单解释器" class="header-anchor">#</a> 简简单单解释器</h2> <p>我们有了 AST，也知道如何去遍历它，那么我们就随时可以求得它的结果啦～</p> <p>也就是说，我们可以直接针对 AST 通过 rust 代码解释执行，就直接得到结果啦～</p> <h3 id="小小符号表"><a href="#小小符号表" class="header-anchor">#</a> 小小符号表</h3> <p>这其实很简单，其本身没什么可说的，但值得注意的是我们可能需要一个符号表用来存放变量相关信息，由于我们的变量都是事先已知的常量，所以符号表里直接存放对应的值就好。同样的，由于我们的变量只能预先定义，所以也不需要考虑变量作用域的问题，都看作全局变量就好。所以我们的符号表实现起来是非常简单的～</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>
<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">SymbolTable</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    map<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token attribute attr-name">#[derive(Debug, PartialEq)]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">SymbolError</span> <span class="token punctuation">{</span>
    <span class="token class-name">ReDefinition</span><span class="token punctuation">,</span>
    <span class="token class-name">UnDefinition</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">SymbolTable</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">where</span>
    <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Copy</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token class-name">SymbolTable</span> <span class="token punctuation">{</span>
            map<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">define</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">String</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SymbolError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">contains_key</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">SymbolError</span><span class="token punctuation">::</span><span class="token class-name">ReDefinition</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">SymbolError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">contains_key</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">SymbolError</span><span class="token punctuation">::</span><span class="token class-name">UnDefinition</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h3 id="开始解释吧"><a href="#开始解释吧" class="header-anchor">#</a> 开始解释吧～</h3> <p>现在我们来实现这个简单的解释器吧～</p> <p>不过这里实现相对于解释器，其实更像是编译时的常量折叠，因为我们所有叶子结点都是常量，所以常量折叠后就是我们需要的计算结果，但把它看作是针对于 AST 的解释器其实也是无伤大雅的～</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">type</span> <span class="token type-definition class-name">Func</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">T</span><span class="token punctuation">;</span>
<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Calculator</span> <span class="token punctuation">{</span>
    variables<span class="token punctuation">:</span> <span class="token class-name">SymbolTable</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    functions<span class="token punctuation">:</span> <span class="token class-name">SymbolTable</span><span class="token operator">&lt;</span><span class="token class-name">Func</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    operand_stack<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">CalculatorError</span> <span class="token punctuation">{</span>
    <span class="token class-name">StackEmpty</span><span class="token punctuation">,</span>
    <span class="token class-name">StackNotEmpty</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> <span class="token class-name">Calculator</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token class-name">Calculator</span> <span class="token punctuation">{</span>
            variables<span class="token punctuation">:</span> <span class="token class-name">SymbolTable</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            functions<span class="token punctuation">:</span> <span class="token class-name">SymbolTable</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            operand_stack<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">result</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token punctuation">,</span> <span class="token class-name">CalculatorError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>operand_stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">None</span> <span class="token operator">=&gt;</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">CalculatorError</span><span class="token punctuation">::</span><span class="token class-name">StackEmpty</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span>operand_stack<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">CalculatorError</span><span class="token punctuation">::</span><span class="token class-name">StackNotEmpty</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        value
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> <span class="token class-name">Visitor</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">Calculator</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_expr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> e<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Expr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> e <span class="token punctuation">{</span>
            <span class="token class-name">Expr</span><span class="token punctuation">::</span><span class="token class-name">UnaryArithmetic</span><span class="token punctuation">(</span><span class="token keyword">ref</span> u<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_unary</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Expr</span><span class="token punctuation">::</span><span class="token class-name">BinaryArithmetic</span><span class="token punctuation">(</span><span class="token keyword">ref</span> b<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_binary</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Expr</span><span class="token punctuation">::</span><span class="token class-name">FunctionCall</span><span class="token punctuation">(</span><span class="token keyword">ref</span> f<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_function</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Expr</span><span class="token punctuation">::</span><span class="token class-name">Atom</span><span class="token punctuation">(</span><span class="token keyword">ref</span> a<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_atom</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_unary</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> u<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">UnaryArithmetic</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_expr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>u<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">match</span> u<span class="token punctuation">.</span>op <span class="token punctuation">{</span>
            <span class="token class-name">UnaryOp</span><span class="token punctuation">::</span><span class="token class-name">Pos</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">UnaryOp</span><span class="token punctuation">::</span><span class="token class-name">Neg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>operand_stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>operand_stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">-</span>value<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">UnaryOp</span><span class="token punctuation">::</span><span class="token class-name">Fac</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>operand_stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>operand_stack
                    <span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">factorial</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_binary</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">BinaryArithmetic</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_expr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">.</span>lhs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_expr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">.</span>rhs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> rhs <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>operand_stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> lhs <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>operand_stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">match</span> b<span class="token punctuation">.</span>op <span class="token punctuation">{</span>
            <span class="token class-name">BinaryOp</span><span class="token punctuation">::</span><span class="token class-name">Add</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>operand_stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>lhs <span class="token operator">+</span> rhs<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">BinaryOp</span><span class="token punctuation">::</span><span class="token class-name">Sub</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>operand_stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>lhs <span class="token operator">-</span> rhs<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">BinaryOp</span><span class="token punctuation">::</span><span class="token class-name">Mul</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>operand_stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>lhs <span class="token operator">*</span> rhs<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">BinaryOp</span><span class="token punctuation">::</span><span class="token class-name">Div</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>operand_stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>lhs <span class="token operator">/</span> rhs<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_function</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">FunctionCall</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> argc <span class="token operator">=</span> f<span class="token punctuation">.</span>args<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> arg <span class="token keyword">in</span> <span class="token operator">&amp;</span>f<span class="token punctuation">.</span>args <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_expr</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> func_name <span class="token operator">=</span> <span class="token operator">&amp;</span>f<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
        <span class="token keyword">let</span> func <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>functions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>func_name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> argv <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>argc <span class="token punctuation">{</span>
            argv<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>operand_stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        argv<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>operand_stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">func</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_atom</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> a<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Atom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> a <span class="token punctuation">{</span>
            <span class="token class-name">Atom</span><span class="token punctuation">::</span><span class="token class-name">Ident</span><span class="token punctuation">(</span><span class="token keyword">ref</span> id<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>operand_stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>variables<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Atom</span><span class="token punctuation">::</span><span class="token class-name">Number</span><span class="token punctuation">(</span><span class="token keyword">ref</span> n<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>operand_stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">*</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function-definition function">factorial</span><span class="token punctuation">(</span>num<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">u64</span> <span class="token punctuation">{</span>
    <span class="token keyword">match</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">..=</span>num<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>accum<span class="token punctuation">,</span> item<span class="token closure-punctuation punctuation">|</span></span> accum <span class="token operator">*</span> item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Some</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> x<span class="token punctuation">,</span>
        <span class="token class-name">None</span> <span class="token operator">=&gt;</span> num<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br></div></div><p>这里我们通过一个操作数栈来存放计算结果，每次计算得到结果就进行压栈，在遇到运算符时从栈顶取得操作数运算后重新压栈。</p> <p>当然不用操作数栈直接使用返回值也是可以的，但那太简单啦，就不试啦～（我才不会承认当时没想到利用泛型让 Vistor 实现不同类型的返回值呜呜）</p> <p>唔，最后实现一下我们当初设计的自定义变量和函数 API ～</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">Calculator</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">define_variable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">String</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SymbolError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>variables<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">define_function</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">String</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token class-name">Func</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SymbolError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>functions<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>现在我们就可以通过下面的方式来自定义变量和函数了～</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code>calculator<span class="token punctuation">.</span><span class="token function">define_variable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">222.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
calculator
    <span class="token punctuation">.</span><span class="token function">define_function</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token string">&quot;mul&quot;</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>args<span class="token closure-punctuation punctuation">|</span></span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>嗯，这样我们就可以完成很多很多事情啦～比如预先定义 PI 的值，再比如预先定义 log、sin、cos 等数学函数，这样我们就可以计算各种各样的结果啦～</p> <p>我们把代码组装一下，现在就可以完成一个非常不错的计算器啦～</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Error</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
   <span class="token keyword">let</span> input <span class="token operator">=</span> <span class="token string">&quot;log(2, 8) - sin(2 * PI)&quot;</span><span class="token punctuation">;</span>
   <span class="token keyword">match</span> <span class="token namespace">calc_parser<span class="token punctuation">::</span></span><span class="token function">expr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Ok</span><span class="token punctuation">(</span>parsed_input<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         <span class="token keyword">let</span> <span class="token keyword">mut</span> calculator <span class="token operator">=</span> <span class="token class-name">Calculator</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         calculator<span class="token punctuation">.</span><span class="token function">preset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         calculator<span class="token punctuation">.</span><span class="token function">define_variable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token string">&quot;PI&quot;</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">consts<span class="token punctuation">::</span></span><span class="token constant">PI</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         calculator<span class="token punctuation">.</span><span class="token function">define_function</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token string">&quot;log&quot;</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>argv<span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">f64</span><span class="token punctuation">::</span><span class="token function">log</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         calculator<span class="token punctuation">.</span><span class="token function">visit_expr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>parsed_input<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">let</span> result <span class="token operator">=</span> calculator<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Calculator Interpret result: {result}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token punctuation">(</span>err_line<span class="token punctuation">,</span> err_col<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>location<span class="token punctuation">.</span>line<span class="token punctuation">,</span> e<span class="token punctuation">.</span>location<span class="token punctuation">.</span>column<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> error_line <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>err_line <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span>
               <span class="token string">&quot;Unexpected char `{}` at line {}, column {}:&quot;</span><span class="token punctuation">,</span>
               error_line<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nth</span><span class="token punctuation">(</span>err_col <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               err_line<span class="token punctuation">,</span>
               err_col
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> error_line<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}{}&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>err_col <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;^&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Excepct chars: {:?}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>expected<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>上面代码最后应当能够计算得到正确的结果 <code>3.0000000000000004</code>～</p> <p>啊，完事啦完事啦～我们这就做完一个计算器啦～～～</p> <p>诶？等会，好像忘了点东西啊，我们的主角 LLVM 呢？？？</p> <h2 id="用-llvm-来-jit-编译一下吧"><a href="#用-llvm-来-jit-编译一下吧" class="header-anchor">#</a> 用 LLVM 来 JIT 编译一下吧～</h2> <p>当然，如果只是一个计算器的话，解释执行完全足够了，编译完全是没必要的，但目的是练手嘛～所以 LLVM 这时候就要强行登场啦～</p> <p>不过此前我对 LLVM 是基本不了解的，所以代码基本都是直接参考的 inkwell 里的 example 和 Rusty Calc，剩下的是看文档猜的……</p> <h3 id="inkwell-的基本结构"><a href="#inkwell-的基本结构" class="header-anchor">#</a> inkwell 的基本结构</h3> <p>首先我们先把一些基本的属性确定下来，比如 LLVM 里的 context、module、builder 什么的。然后，我们实现一个只能计算数字常量最简 JIT 编译器，这个直接参考 inkwell 的 JIT example 就可以写出来～</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">type</span> <span class="token type-definition class-name">CalcMain</span> <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">f64</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">CALC_ENTRYPOINT</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token operator">=</span> <span class="token string">&quot;calc_main&quot;</span><span class="token punctuation">;</span>
<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CalculatorJIT</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'ctx</span> <span class="token class-name">Context</span><span class="token punctuation">,</span>
    module<span class="token punctuation">:</span> <span class="token class-name">Module</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    builder<span class="token punctuation">:</span> <span class="token class-name">Builder</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    execution_engine<span class="token punctuation">:</span> <span class="token class-name">ExecutionEngine</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token class-name">CalculatorJIT</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>context<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'ctx</span> <span class="token class-name">Context</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> module <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">create_module</span><span class="token punctuation">(</span><span class="token string">&quot;calc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> execution_engine <span class="token operator">=</span> module
            <span class="token punctuation">.</span><span class="token function">create_jit_execution_engine</span><span class="token punctuation">(</span><span class="token class-name">OptimizationLevel</span><span class="token punctuation">::</span><span class="token class-name">None</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CalculatorJIT</span> <span class="token punctuation">{</span>
            context<span class="token punctuation">:</span> <span class="token operator">&amp;</span>context<span class="token punctuation">,</span>
            module<span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> context<span class="token punctuation">.</span><span class="token function">create_builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            execution_engine<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token attribute attr-name">#[inline]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">double</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">FloatType</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">f64_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">compile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> ast<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Expr</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">JitFunction</span><span class="token operator">&lt;</span><span class="token class-name">CalcMain</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> sig <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">double</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fn_type</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> func <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>module<span class="token punctuation">.</span><span class="token function">add_function</span><span class="token punctuation">(</span><span class="token constant">CALC_ENTRYPOINT</span><span class="token punctuation">,</span> sig<span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> basic_block <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">append_basic_block</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token string">&quot;entry&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>builder<span class="token punctuation">.</span><span class="token function">position_at_end</span><span class="token punctuation">(</span>basic_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_expr</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>builder<span class="token punctuation">.</span><span class="token function">build_return</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token keyword">self</span><span class="token punctuation">.</span>execution_engine<span class="token punctuation">.</span><span class="token function">get_function</span><span class="token punctuation">(</span><span class="token constant">CALC_ENTRYPOINT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token class-name">Visitor</span><span class="token operator">&lt;</span><span class="token class-name">FloatValue</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;&gt;</span> <span class="token keyword">for</span> <span class="token class-name">CalculatorJIT</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_expr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> e<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Expr</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">FloatValue</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> e <span class="token punctuation">{</span>
            <span class="token class-name">Expr</span><span class="token punctuation">::</span><span class="token class-name">UnaryArithmetic</span><span class="token punctuation">(</span><span class="token keyword">ref</span> u<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_unary</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Expr</span><span class="token punctuation">::</span><span class="token class-name">BinaryArithmetic</span><span class="token punctuation">(</span><span class="token keyword">ref</span> b<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_binary</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Expr</span><span class="token punctuation">::</span><span class="token class-name">FunctionCall</span><span class="token punctuation">(</span><span class="token keyword">ref</span> f<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_function</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Expr</span><span class="token punctuation">::</span><span class="token class-name">Atom</span><span class="token punctuation">(</span><span class="token keyword">ref</span> a<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_atom</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_atom</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> a<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Atom</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">FloatValue</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> a <span class="token punctuation">{</span>
            <span class="token class-name">Atom</span><span class="token punctuation">::</span><span class="token class-name">Ident</span><span class="token punctuation">(</span><span class="token keyword">ref</span> id<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token macro property">unimplemented!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Atom</span><span class="token punctuation">::</span><span class="token class-name">Number</span><span class="token punctuation">(</span><span class="token keyword">ref</span> n<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">double</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">const_float</span><span class="token punctuation">(</span><span class="token operator">*</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Error</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> input <span class="token operator">=</span> <span class="token string">&quot;1.1&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">match</span> <span class="token namespace">calc_parser<span class="token punctuation">::</span></span><span class="token function">expr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>parsed_input<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> context <span class="token operator">=</span> <span class="token class-name">Context</span><span class="token punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> calculator_jit <span class="token operator">=</span> <span class="token class-name">CalculatorJIT</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> calc_main <span class="token operator">=</span> calculator_jit<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>parsed_input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> calc_main<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;JIT compile result: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token macro property">unimplemented!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><p>不出意外，上面的代码是可以直接计算得到结果 1.1 的。</p> <p>那我们 JIT 编译到底有什么用呢？其实这里我们编译得到的 calc_main 以后是可以重复调用的，不必每次都从 AST 解释计算。</p> <h3 id="用-builder-构建运算"><a href="#用-builder-构建运算" class="header-anchor">#</a> 用 builder 构建运算</h3> <p>下面我们逐渐完善计算相关的代码</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token class-name">Visitor</span><span class="token operator">&lt;</span><span class="token class-name">FloatValue</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;&gt;</span> <span class="token keyword">for</span> <span class="token class-name">CalculatorJIT</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_unary</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> u<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">UnaryArithmetic</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">FloatValue</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_expr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>u<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">match</span> u<span class="token punctuation">.</span>op <span class="token punctuation">{</span>
            <span class="token class-name">UnaryOp</span><span class="token punctuation">::</span><span class="token class-name">Pos</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">,</span>
            <span class="token class-name">UnaryOp</span><span class="token punctuation">::</span><span class="token class-name">Neg</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>builder<span class="token punctuation">.</span><span class="token function">build_float_neg</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">&quot;neg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">UnaryOp</span><span class="token punctuation">::</span><span class="token class-name">Fac</span> <span class="token operator">=&gt;</span> <span class="token macro property">unimplemented!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_binary</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">BinaryArithmetic</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">FloatValue</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> lhs <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_expr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">.</span>lhs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> rhs <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_expr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">.</span>rhs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">match</span> b<span class="token punctuation">.</span>op <span class="token punctuation">{</span>
            <span class="token class-name">BinaryOp</span><span class="token punctuation">::</span><span class="token class-name">Add</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>builder<span class="token punctuation">.</span><span class="token function">build_float_add</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">,</span> <span class="token string">&quot;add&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">BinaryOp</span><span class="token punctuation">::</span><span class="token class-name">Sub</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>builder<span class="token punctuation">.</span><span class="token function">build_float_sub</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">,</span> <span class="token string">&quot;sub&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">BinaryOp</span><span class="token punctuation">::</span><span class="token class-name">Mul</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>builder<span class="token punctuation">.</span><span class="token function">build_float_mul</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">,</span> <span class="token string">&quot;mul&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">BinaryOp</span><span class="token punctuation">::</span><span class="token class-name">Div</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>builder<span class="token punctuation">.</span><span class="token function">build_float_div</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">,</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>一元运算二元运算都很简单，直接通过 builder 里的操作构建相关的代码就好，不过阶乘这样复杂的操作暂时是没办法完成的。</p> <p>嗯，现在我们应该能做一些复杂的运算了，比如 <code>1 * 2 / -4</code> 等等。</p> <h3 id="定义全局变量"><a href="#定义全局变量" class="header-anchor">#</a> 定义全局变量</h3> <p>下面我们支持一下变量吧，由于我们的变量都是预先定义好的，因此可看作全局变量，其地址可存在符号表之中，</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CalculatorJIT</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 增加变量符号表属性</span>
    variables<span class="token punctuation">:</span> <span class="token class-name">SymbolTable</span><span class="token operator">&lt;</span><span class="token class-name">PointerValue</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token class-name">CalculatorJIT</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">define_variable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">String</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SymbolError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> var <span class="token operator">=</span> <span class="token keyword">self</span>
            <span class="token punctuation">.</span>module
            <span class="token punctuation">.</span><span class="token function">add_global</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">double</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">AddressSpace</span><span class="token punctuation">::</span><span class="token class-name">Global</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 赋初值</span>
        <span class="token keyword">let</span> initial_value <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">double</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">const_float</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        var<span class="token punctuation">.</span><span class="token function">set_initializer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>initial_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取地址</span>
        <span class="token keyword">let</span> alloca <span class="token operator">=</span> var<span class="token punctuation">.</span><span class="token function">as_pointer_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>variables<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> alloca<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">get_variable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">FloatValue</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">SymbolError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 直接从符号表取得地址</span>
        <span class="token keyword">let</span> alloca <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>variables<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> var <span class="token operator">=</span> <span class="token keyword">self</span>
            <span class="token punctuation">.</span>builder
            <span class="token punctuation">.</span><span class="token function">build_load</span><span class="token punctuation">(</span>alloca<span class="token punctuation">,</span> name<span class="token punctuation">.</span><span class="token function">as_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">into_float_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>var<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token class-name">Visitor</span><span class="token operator">&lt;</span><span class="token class-name">FloatValue</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;&gt;</span> <span class="token keyword">for</span> <span class="token class-name">CalculatorJIT</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_atom</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> a<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Atom</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">FloatValue</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> a <span class="token punctuation">{</span>
            <span class="token comment">// 增加变量的处理</span>
            <span class="token class-name">Atom</span><span class="token punctuation">::</span><span class="token class-name">Ident</span><span class="token punctuation">(</span><span class="token keyword">ref</span> id<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">get_variable</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Atom</span><span class="token punctuation">::</span><span class="token class-name">Number</span><span class="token punctuation">(</span><span class="token keyword">ref</span> n<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">double</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">const_float</span><span class="token punctuation">(</span><span class="token operator">*</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h3 id="定义函数"><a href="#定义函数" class="header-anchor">#</a> 定义函数</h3> <p>函数的定义也很相似，这里同样为了方便定义函数，也使用闭包的形式，不过为了方便闭包里构建各种操作，所以把 builder 也一并传入。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">type</span> <span class="token type-definition class-name">FuncLLVM</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token class-name">Builder</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">T</span><span class="token punctuation">;</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token class-name">CalculatorJIT</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">define_function</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">String</span><span class="token punctuation">,</span>
        argc<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
        func<span class="token punctuation">:</span> <span class="token class-name">FuncLLVM</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token punctuation">,</span> <span class="token class-name">FloatValue</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SymbolError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> ret_type <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">double</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> args_types <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>iter<span class="token punctuation">::</span></span><span class="token function">repeat</span><span class="token punctuation">(</span>ret_type<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span>argc<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>f<span class="token closure-punctuation punctuation">|</span></span> f<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">BasicMetadataTypeEnum</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> args_types <span class="token operator">=</span> args_types<span class="token punctuation">.</span><span class="token function">as_slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> fn_type <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">double</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fn_type</span><span class="token punctuation">(</span>args_types<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> fn_val <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>module<span class="token punctuation">.</span><span class="token function">add_function</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">as_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fn_type<span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> entry <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">append_basic_block</span><span class="token punctuation">(</span>fn_val<span class="token punctuation">,</span> <span class="token string">&quot;entry&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>builder<span class="token punctuation">.</span><span class="token function">position_at_end</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> args <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>argc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>argc <span class="token keyword">as</span> <span class="token keyword">u32</span> <span class="token punctuation">{</span>
            args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn_val<span class="token punctuation">.</span><span class="token function">get_nth_param</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into_float_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> ret_val <span class="token operator">=</span> <span class="token function">func</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>builder<span class="token punctuation">.</span><span class="token function">build_return</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ret_val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_function</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">FunctionValue</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">SymbolError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>module<span class="token punctuation">.</span><span class="token function">get_function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">None</span> <span class="token operator">=&gt;</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">SymbolError</span><span class="token punctuation">::</span><span class="token class-name">UnDefinition</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token class-name">Visitor</span><span class="token operator">&lt;</span><span class="token class-name">FloatValue</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;&gt;</span> <span class="token keyword">for</span> <span class="token class-name">CalculatorJIT</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">visit_function</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">FunctionCall</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">FloatValue</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'ctx</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> argc <span class="token operator">=</span> f<span class="token punctuation">.</span>args<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> func <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">get_function</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>f<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> argv <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>argc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>argc <span class="token punctuation">{</span>
            argv<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">visit_expr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>f<span class="token punctuation">.</span>args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> argsv<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">BasicMetadataValueEnum</span><span class="token operator">&gt;</span> <span class="token operator">=</span>
            argv<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">by_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token operator">&amp;</span>val<span class="token closure-punctuation punctuation">|</span></span> val<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> ret_val <span class="token operator">=</span> <span class="token keyword">self</span>
            <span class="token punctuation">.</span>builder
            <span class="token punctuation">.</span><span class="token function">build_call</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> argsv<span class="token punctuation">.</span><span class="token function">as_slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;tmp&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">try_as_basic_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">left</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret_val<span class="token punctuation">.</span><span class="token function">into_float_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><p>嘛，虽然看着挺麻烦的，不过参考 example 还是很容易写出来的～</p> <p>现在我们就可以自己定义常量和函数啦～</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code>calculator_jit<span class="token punctuation">.</span><span class="token function">define_variable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">222.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
calculator_jit
    <span class="token punctuation">.</span><span class="token function">define_function</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token string">&quot;mul&quot;</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>args<span class="token punctuation">,</span> builder<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> a <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> b <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">build_float_mul</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token string">&quot;mul&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>不过实现 log、sin 这种函数还是不太行啦，只能实现一些非常简单的函数。</p> <p>总算是完成啦，到此为止我们不仅快速实现了一个解释型的计算器，还实现了一个与其基本功能一致的 JIT 编译型的计算器～</p> <p>代码就扔到 <a href="https://github.com/ShigureLab/rcalc" target="_blank" rel="noopener noreferrer">ShigureLab/rcalc<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 咯～溜了溜了～</p> <h2 id="references"><a href="#references" class="header-anchor">#</a> References</h2> <ol><li><a href="https://michael-f-bryan.github.io/calc/book/html/intro.html" target="_blank" rel="noopener noreferrer">Rusty Calc<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/TheDan64/inkwell" target="_blank" rel="noopener noreferrer">inkwell examples<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.slideshare.net/RReverser/building-fast-interpreters-in-rust" target="_blank" rel="noopener noreferrer">building-fast-interpreters-in-rust<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol></div></article> <section class="post-meta main-div" data-v-3c27fa5a><section class="post-date clearfix" data-v-3c27fa5a><span class="create-date" data-v-3c27fa5a>
      发布时间 : 2022-01-21
    </span> <span class="update-date" data-v-3c27fa5a>
      最后修改 : 2023-08-28
    </span></section> <section class="post-links" data-v-3c27fa5a><a href="/posts/2021/02/10/proxy-and-vue3-reactivity.html" class="post-link" data-v-3c27fa5a>
      上一篇 : Proxy 以及 Vue3 中的响应式
    </a> <a href="/posts/2022/09/21/moefy-paddle-dx-improvements.html" class="post-link" data-v-3c27fa5a>
      下一篇 : 让 Paddle 更可爱——开发者体验提升计划
    </a></section></section> <!----></div></main> <aside class="aside" data-v-5e296355><div class="info-card main-div" data-v-d24226c8 data-v-5e296355><div class="info-card-header" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/info-bg.webp);" data-v-d24226c8><img src="/avatar.jpg" alt="喵ック" class="info-avatar" data-v-d24226c8></div> <div class="info-card-body" data-v-d24226c8><section class="info-nickname" data-v-d24226c8>
      喵ック
    </section> <section class="info-desc" data-v-d24226c8>可爱是第一驱动力～</section> <section class="info-contact" data-v-d24226c8><section data-v-d24226c8><span title="Beijing, China" data-v-d24226c8 data-v-d24226c8><svg class="icon" style="font-size:1em;" data-v-d24226c8 data-v-d24226c8><title data-v-d24226c8 data-v-d24226c8>Beijing, China</title><use xlink:href="#icon-location" data-v-d24226c8 data-v-d24226c8></use></svg><span class="info-text" data-v-d24226c8 data-v-d24226c8>
          Beijing, China
        </span></span></section> <section data-v-d24226c8><span title="PaddlePaddle" data-v-d24226c8 data-v-d24226c8><svg class="icon" style="font-size:1em;" data-v-d24226c8 data-v-d24226c8><title data-v-d24226c8 data-v-d24226c8>PaddlePaddle</title><use xlink:href="#icon-organization" data-v-d24226c8 data-v-d24226c8></use></svg><span class="info-text" data-v-d24226c8 data-v-d24226c8>
          PaddlePaddle
        </span></span></section> <section data-v-d24226c8><a href="mailto:sigure.qaq@gmail.com" title="sigure.qaq@gmail.com" data-v-d24226c8 data-v-d24226c8><svg class="icon" style="font-size:1em;" data-v-d24226c8 data-v-d24226c8><title data-v-d24226c8 data-v-d24226c8>sigure.qaq@gmail.com</title><use xlink:href="#icon-email" data-v-d24226c8 data-v-d24226c8></use></svg><span class="info-text" data-v-d24226c8 data-v-d24226c8>
          sigure.qaq@gmail.com
        </span></a></section></section></div> <div class="info-card-footer" data-v-d24226c8><section class="info-sns clearfix" data-v-d24226c8><a href="https://github.com/SigureMo" target="_blank" class="sns-link" data-v-d24226c8><span title="GitHub: SigureMo" class="sns-icon" data-v-d24226c8 data-v-d24226c8><svg class="icon" style="font-size:1.5em;" data-v-d24226c8 data-v-d24226c8><title data-v-d24226c8 data-v-d24226c8>GitHub: SigureMo</title><use xlink:href="#icon-github" data-v-d24226c8 data-v-d24226c8></use></svg></span></a></section></div></div> <div class="post-nav-card main-div" style="position:relative;top:0;width:0px;" data-v-5e296355><div class="post-nav-contents"><svg class="icon"><title>book</title><use xlink:href="#icon-book"></use></svg> <span>文章目录</span> <div class="post-nav-toc"><ul><li><a href="/posts/2022/01/21/lets-make-a-calculator-using-rust-and-llvm.html#做个什么样的计算器呢">做个什么样的计算器呢？</a></li><li><a href="/posts/2022/01/21/lets-make-a-calculator-using-rust-and-llvm.html#设计一下-ast-结构">设计一下 AST 结构</a><ul><li><a href="/posts/2022/01/21/lets-make-a-calculator-using-rust-and-llvm.html#数字与变量">数字与变量</a></li><li><a href="/posts/2022/01/21/lets-make-a-calculator-using-rust-and-llvm.html#运算符">运算符</a></li><li><a href="/posts/2022/01/21/lets-make-a-calculator-using-rust-and-llvm.html#函数调用">函数调用</a></li><li><a href="/posts/2022/01/21/lets-make-a-calculator-using-rust-and-llvm.html#表达式结点">表达式结点</a></li></ul></li><li><a href="/posts/2022/01/21/lets-make-a-calculator-using-rust-and-llvm.html#用-peg-同时完成词法、语法分析">用 peg 同时完成词法、语法分析</a></li><li><a href="/posts/2022/01/21/lets-make-a-calculator-using-rust-and-llvm.html#为-ast-实现-visitor">为 AST 实现 visitor</a></li><li><a href="/posts/2022/01/21/lets-make-a-calculator-using-rust-and-llvm.html#简简单单解释器">简简单单解释器</a><ul><li><a href="/posts/2022/01/21/lets-make-a-calculator-using-rust-and-llvm.html#小小符号表">小小符号表</a></li><li><a href="/posts/2022/01/21/lets-make-a-calculator-using-rust-and-llvm.html#开始解释吧">开始解释吧～</a></li></ul></li><li><a href="/posts/2022/01/21/lets-make-a-calculator-using-rust-and-llvm.html#用-llvm-来-jit-编译一下吧">用 LLVM 来 JIT 编译一下吧～</a><ul><li><a href="/posts/2022/01/21/lets-make-a-calculator-using-rust-and-llvm.html#inkwell-的基本结构">inkwell 的基本结构</a></li><li><a href="/posts/2022/01/21/lets-make-a-calculator-using-rust-and-llvm.html#用-builder-构建运算">用 builder 构建运算</a></li><li><a href="/posts/2022/01/21/lets-make-a-calculator-using-rust-and-llvm.html#定义全局变量">定义全局变量</a></li><li><a href="/posts/2022/01/21/lets-make-a-calculator-using-rust-and-llvm.html#定义函数">定义函数</a></li></ul></li><li><a href="/posts/2022/01/21/lets-make-a-calculator-using-rust-and-llvm.html#references">References</a></li></ul></div></div> <!----></div></aside></div> <footer class="footer" data-v-a9a89600><p class="footer-sns-links" data-v-a9a89600><a href="https://github.com/SigureMo" target="_blank" class="sns-link" data-v-a9a89600><span title="GitHub: SigureMo" class="sns-icon" data-v-a9a89600 data-v-a9a89600><svg class="icon" style="font-size:25px;" data-v-a9a89600 data-v-a9a89600><title data-v-a9a89600 data-v-a9a89600>GitHub: SigureMo</title><use xlink:href="#icon-github" data-v-a9a89600 data-v-a9a89600></use></svg></span></a></p> <p class="footer-text" data-v-a9a89600><span data-v-a9a89600>Powered by </span> <a href="https://github.com/vuejs/vuepress" target="_blank" data-v-a9a89600>
      VuePress
    </a> <span data-v-a9a89600> | </span> <a href="https://github.com/meteorlxy/vuepress-theme-meteorlxy" target="_blank" data-v-a9a89600>
        meteorlxy
      </a></p> <p class="footer-text" data-v-a9a89600>Copyright 2018-present <a href="https://github.com/SigureMo" target="_blank">Nyakku</a> | <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA-4.0</a></p></footer></div><div class="global-ui"><!----><!----><!----><canvas id="vuepress-canvas-ribbon"></canvas><canvas id="vuepress-canvas-cursor"></canvas><div></div><div id="goTop" class="hide-cat" data-v-f6babb38></div><APlayer audio="" fixed="true" theme="#b7daff" loop="loop" order="list" preload="metadata" volume="0.7" mutex="true" lrc-type="3" list-max-height="250" storage-name="vuepress-plugin-meting" id="aplayer-fixed"></APlayer></div></div>
    <script src="/assets/js/app.6ffe9626.js" defer></script><script src="/assets/js/7.f870edc6.js" defer></script><script src="/assets/js/32.4ac19872.js" defer></script><script src="/assets/js/23.f4ab9440.js" defer></script>
  </body>
</html>
