<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>哇，好复杂的 TorchDynamo，我们拆开看看吧～ | Notev</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/favicon152.png">
    <link rel="mask-icon" href="/icons/favicon152.png" color="#3eaf7c">
    <link rel="alternate" type="application/rss+xml" href="https://nyakku.moe/rss.xml" title="Notev RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://nyakku.moe/feed.atom" title="Notev Atom Feed">
    <link rel="alternate" type="application/json" href="https://nyakku.moe/feed.json" title="Notev JSON Feed">
    <meta name="description" content="一个小透明的透明世界">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta property="og:url" content="https://nyakku.moe">
    <meta property="og:site_name" content="Notev">
    <meta property="og:image" content="/bg.webp">
    <meta property="og:description" content="一个小透明的透明世界">
    <meta property="og:title" content="Notev">
    <meta name="theme-color" content="#222222">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/favicon144.png">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/assets/css/0.styles.ae4bc851.css" as="style"><link rel="preload" href="/assets/js/app.6ffe9626.js" as="script"><link rel="preload" href="/assets/js/7.f870edc6.js" as="script"><link rel="preload" href="/assets/js/15.bc180d2d.js" as="script"><link rel="preload" href="/assets/js/23.f4ab9440.js" as="script"><link rel="prefetch" href="/assets/js/1.e3010140.js"><link rel="prefetch" href="/assets/js/10.ba769f1e.js"><link rel="prefetch" href="/assets/js/12.e6a9d16c.js"><link rel="prefetch" href="/assets/js/13.cbe40062.js"><link rel="prefetch" href="/assets/js/14.de8176b8.js"><link rel="prefetch" href="/assets/js/16.77ffbcb1.js"><link rel="prefetch" href="/assets/js/17.a1263238.js"><link rel="prefetch" href="/assets/js/18.ccc050d1.js"><link rel="prefetch" href="/assets/js/19.a175bc31.js"><link rel="prefetch" href="/assets/js/2.da6cc646.js"><link rel="prefetch" href="/assets/js/20.21f2579f.js"><link rel="prefetch" href="/assets/js/21.a45600e0.js"><link rel="prefetch" href="/assets/js/22.51d6df0c.js"><link rel="prefetch" href="/assets/js/24.41e79c9e.js"><link rel="prefetch" href="/assets/js/25.4dc327c4.js"><link rel="prefetch" href="/assets/js/26.219d9641.js"><link rel="prefetch" href="/assets/js/27.b5a79c37.js"><link rel="prefetch" href="/assets/js/28.8ae7e0e6.js"><link rel="prefetch" href="/assets/js/29.64423761.js"><link rel="prefetch" href="/assets/js/3.27a8c8d5.js"><link rel="prefetch" href="/assets/js/30.622bb606.js"><link rel="prefetch" href="/assets/js/31.f41defd2.js"><link rel="prefetch" href="/assets/js/32.4ac19872.js"><link rel="prefetch" href="/assets/js/33.0a79b200.js"><link rel="prefetch" href="/assets/js/34.f5dd158b.js"><link rel="prefetch" href="/assets/js/35.6b94bddf.js"><link rel="prefetch" href="/assets/js/36.1e466a55.js"><link rel="prefetch" href="/assets/js/37.01407288.js"><link rel="prefetch" href="/assets/js/38.b3f1fe79.js"><link rel="prefetch" href="/assets/js/39.7290bc98.js"><link rel="prefetch" href="/assets/js/4.41086855.js"><link rel="prefetch" href="/assets/js/40.91deb8af.js"><link rel="prefetch" href="/assets/js/41.ccf520e8.js"><link rel="prefetch" href="/assets/js/42.c7bd3d1a.js"><link rel="prefetch" href="/assets/js/43.3c8f205d.js"><link rel="prefetch" href="/assets/js/44.7ff432ec.js"><link rel="prefetch" href="/assets/js/45.089b4679.js"><link rel="prefetch" href="/assets/js/46.8dd233b3.js"><link rel="prefetch" href="/assets/js/47.a86d6e2d.js"><link rel="prefetch" href="/assets/js/5.ff46fbd2.js"><link rel="prefetch" href="/assets/js/6.309dd07b.js"><link rel="prefetch" href="/assets/js/8.4a2e364b.js"><link rel="prefetch" href="/assets/js/9.e60d35ed.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ae4bc851.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-meteorlxy"><header class="header" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/bg.webp);" data-v-548d63b6><div data-v-2ce53547 data-v-548d63b6><nav class="navbar" data-v-2ce53547><div class="container" data-v-2ce53547><a href="/" class="router-link-active" data-v-2ce53547><span class="navbar-site-name" data-v-2ce53547>
          Notev
        </span></a> <div class="navbar-toggler" data-v-2ce53547><svg class="icon" style="font-size:1.2em;" data-v-2ce53547 data-v-2ce53547><title data-v-2ce53547 data-v-2ce53547>menu</title><use xlink:href="#icon-menu" data-v-2ce53547 data-v-2ce53547></use></svg></div> <div class="navbar-links" data-v-2ce53547><a href="/" class="navbar-link" data-v-2ce53547>
            Home
          </a><a href="/posts/" class="navbar-link router-link-active" data-v-2ce53547>
            Posts
          </a><a href="/friends.html" class="navbar-link" data-v-2ce53547>
            Friends
          </a><a href="/about.html" class="navbar-link" data-v-2ce53547>
            About
          </a><a href="https://github.com/SigureMo/notev" target="_blank" rel="noopener noreferrer" class="navbar-link" data-v-2ce53547><span data-v-2ce53547>GitHub</span> <span data-v-2ce53547><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div></div></nav> <div class="navbar-holder" style="display:none;" data-v-2ce53547></div></div> <div class="banner" data-v-554dc8f4 data-v-548d63b6 data-v-548d63b6><div class="container" data-v-554dc8f4><div class="center" data-v-554dc8f4><h1 data-v-554dc8f4 data-v-548d63b6>
          哇，好复杂的 TorchDynamo，我们拆开看看吧～
        </h1></div></div></div></header> <div class="container clearfix show-aside" data-v-5e296355 data-v-5e296355><main class="main" data-v-5e296355><div class="post" data-v-5e296355 data-v-5e296355><section class="post-meta main-div" data-v-3c27fa5a><section class="post-date clearfix" data-v-3c27fa5a><span class="create-date" data-v-3c27fa5a>
      发布时间 : 2023-04-22
    </span> <span class="update-date" data-v-3c27fa5a>
      最后修改 : 2023-08-28
    </span></section> <section class="post-links" data-v-3c27fa5a><a href="/posts/2022/09/21/moefy-paddle-dx-improvements.html" class="post-link" data-v-3c27fa5a>
      上一篇 : 让 Paddle 更可爱——开发者体验提升计划
    </a> <a href="/posts/2023/08/27/python311-instruction-specializing.html" class="post-link" data-v-3c27fa5a>
      下一篇 : Python 3.11 核心加速原理——指令特化
    </a></section></section> <article class="main-div"><div class="post-content content content__default"><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>最近这一周负责调研 TorchDynamo，唔，也是很久没写博客了嘛，所以就浅记录下，顺便梳理下 Dynamo 中的各个流程和部分细节～</p> <p>注意本文最初的动机是调研，因此内容排布上可能对新手不是很友好。因为一直没时间整理优化，暂时先这样了。</p></div> <h2 id="什么是-torchdynamo"><a href="#什么是-torchdynamo" class="header-anchor">#</a> 什么是 TorchDynamo</h2> <p>TorchDynamo 是一个 Python JIT 编译器，可以提高 PyTorch 代码的运行速度。那，它是怎么做到的呢？</p> <h3 id="torchdynamo-总览"><a href="#torchdynamo-总览" class="header-anchor">#</a> TorchDynamo 总览</h3> <p><img alt="TorchDynamo Overview" data-src="/assets/img/dynamo-overview.69905ffa.png" loading="lazy" class="lazy"></p> <p>这里本想自己画一个流程图的，不过最后发现 Torch 文档里的这张图本身已经足够说明 TorchDynamo 的工作流程了，所以这里就直接用啦～</p> <p>对于一个 Python 函数来说，默认当然就是直接用 Python 解释器来执行了，或者更严谨一点来说会将此时的 Frame 会交给 Python 解释器来 Eval。而 <a href="https://peps.python.org/pep-0523/" target="_blank" rel="noopener noreferrer">PEP 523<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 为我们提供了一个修改 Python 解释器 Eval Frame 行为的方法，让我们能够可以自己来解释执行 Frame。TorchDynamo 便是基于此原理来实现的。</p> <p>对于同样一个 Python 函数，TorchDynamo 会在 Eval Frame 时通过编译将原始的 Frame 转换成一个新的 Frame，两者主要差异在于字节码上，这个新的 Frame 同样会交给 Python 解释器来执行，也就是说 TorchDynamo 的主要工作是在 Eval Frame 初期的字节码变换过程。</p> <p>图中我们会看到有一个 Guards，它是用来保护 Cache 中直接获取的 CodeObject 的，对于同一个函数的 CodeObject，并不是说编译一次对于之后所有的输入都是可用的，因为 TorchDynamo 的编译过程强依赖于输入类型和值等信息，因此第一次编译后的 CodeObject 可能对于第二次输入是不适用的，Guard 便是用来检查此项的，当 Guard 检查失败时，就会触发重新编译。</p> <h3 id="torchdynamo-编译过程"><a href="#torchdynamo-编译过程" class="header-anchor">#</a> TorchDynamo 编译过程</h3> <p>TorchDynamo 在编译过程中会逐字节码进行模拟执行，相当于实现了一个简版的 Python 解释器，在这个过程中会收集所有栈上变量的信息，以及其相关的操作，这也是为什么图中会写「dynamic bytecode analysis」，区别于静态分析，TorchDynamo 可以从 Frame 的 <code>f_locals</code> 字段里找到函数的输入，进而将整个函数运行过程模拟出来。</p> <p>在模拟执行的过程中，如果 TorchDynamo 遇到了 Tensor，就会创建一个 FX Proxy，开始 FX Graph 组网过程，即开始 trace。</p> <p>在模拟执行结束时，首先会从 FX Graph 生成 Python 函数，并将其挂载到 globals 里。之后在生成的字节码里先将这个函数 LOAD 到栈里，然后将所有输入也 LOAD 到栈上，之后 CALL 这个函数。当然，仅仅凭借如此是无法把全部操作都还原的，对于一些 Python 的 SideEffects，还需要在最后生成相关代码来处理。</p> <p>这里真正起到加速作用的是 FX Graph，FX Graph 是可以交给各种后端进行编译加速的，比如默认的 TorchInductor 会将 FX Graph 编译到 Triton（GPU）或 C++/OpenMP（CPU）。</p> <h2 id="eval-frame-原理和执行流程"><a href="#eval-frame-原理和执行流程" class="header-anchor">#</a> Eval Frame 原理和执行流程</h2> <h3 id="frameobject-和-codeobject"><a href="#frameobject-和-codeobject" class="header-anchor">#</a> FrameObject 和 CodeObject</h3> <p>CodeObject 是指 Python 经过编译后产生的代码对象，它主要包含了 Python 字节码及其相关信息，比如常量表、变量名表等。</p> <p>FrameObject 是指在函数运行时的栈帧，包含编译时产生的 CodeObject 以及一些运行时的参数信息等。</p> <p>简单来说，CodeObject 是一个编译时的产物，而 FrameObject 时一个运行时的概念，同一个函数多次运行会产生多个 FrameObject，而其对应的 CodeObject 是同一个。</p> <h3 id="pep-523"><a href="#pep-523" class="header-anchor">#</a> PEP 523</h3> <p><a href="https://peps.python.org/pep-0523/" target="_blank" rel="noopener noreferrer">PEP 523<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的标题是 Adding a frame evaluation API to CPython，即为 CPython 添加一个用来 Eval Frame 的 API。这个提案为 JIT 编译提供了可能，允许 JIT 编译器在 Eval Frame 时执行自己的一些操作，比如重新编译原有 CodeObject 生成新的 CodeObject 等。</p> <p>因此该提案在 <code>PyInterpreterState</code> 上增加了一个 <code>eval_frame</code> 字段，即在 Eval Frame 时会调用的函数。其默认值即是直接调用 Python 解释器默认行为 <code>_PyEval_EvalFrameDefault</code> 函数。而我们可以通过修改它来实现 Eval Frame 行为的自定义，</p> <p>此外，该提案还在 CodeObject 上添加了一个 <code>co_extra</code> 字段，以便 JIT 编译器在编译时将一些额外的信息存储在 CodeObject 中，比如编译后的 CodeObject 等。</p> <h3 id="eval-frame-流程"><a href="#eval-frame-流程" class="header-anchor">#</a> Eval Frame 流程</h3> <p>原理基本都介绍完啦，下面说一下 TorchDynamo 在 Eval Frame 时发生的具体过程。</p> <p>对于使用 <code>torch.compile</code> 装饰的函数 <code>fn</code>，torch 会生成一个 <code>callback</code>，用于编译 Frame 生成新的 CodeObject，同时这个函数会被装饰成如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token decorator annotation punctuation">@functools<span class="token punctuation">.</span>wraps</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">_fn</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
   prior <span class="token operator">=</span> set_eval_frame<span class="token punctuation">(</span>callback<span class="token punctuation">)</span>
   <span class="token keyword">try</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> fn<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
   <span class="token keyword">finally</span><span class="token punctuation">:</span>
      set_eval_frame<span class="token punctuation">(</span>prior<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在调用 <code>set_eval_frame</code> 时，Dynamo 会将通过 <code>tstate-&gt;interp-&gt;eval_frame = &amp;custom_eval_frame_shim;</code> 来将 Eval Frame 行为替换成自己的 <code>custom_eval_frame_shim</code>。这样之后调用的 <code>fn</code> 便是由 Dynamo 自己的 <code>custom_eval_frame_shim</code> 来执行的。</p> <p><img alt="Dynamo Eval Frame" data-src="/assets/img/dynamo-eval-frame.drawio.f8dd9469.png" loading="lazy" class="lazy"></p> <p><code>custom_eval_frame_shim</code> 的源码分析图如上，我们看一下它具体是如何工作的。</p> <p>首先，对于 Eval Frame 来说，当然是可以获取到 FrameObject 的，同样也可以从中获取 CodeObject。根据 PEP 523，我们可以在 <code>co_extra</code> 字段里存储一些 Cache，这里便会存储 Dynamo 编译后的 CodeObject，值得注意的是，这里 <code>CacheEntry</code> 是同时包含 <code>check_fn</code> 和 <code>code</code> 字段的，<code>check_fn</code> 即是用于检查一个编译后的 CodeObject 是否可用的，<code>check_fn</code> 会作用于 <code>f_locals</code>（即 <code>check_fn(f_locals)</code>）来检查该 Cache 是否可用。这主要分为以下三种情况：</p> <ul><li>其中 CacheEntry 是一个链表，默认最大长度为 64，如果查找全部 Cache 都不可用时，就会认为是 cache miss；</li> <li>而当 <code>check_fn(f_locals)</code> 检查成功时，就会认为 cache hit；</li> <li>此外还有一种情况，是 cache 里存储的是 <code>SKIP_CODE</code>。</li></ul> <p>另外，Dynamo 会根据 callback 的情况分别执行如下操作：</p> <ul><li>当 callback 为 <code>Py_None</code> 时，会直接跑原生字节码，即直接由 <code>eval_frame_default</code> 来执行；</li> <li>当 callback 为 <code>Py_False</code> 时，表示只运行但不 compile，即如果 cache hit 就跑 <code>eval_custom_code</code>，cache miss 就跑 <code>eval_frame_default</code></li> <li>当 callback 为一个 callable 函数时，表示运行且 compile，同样在 cache hit 时直接跑 <code>eval_custom_code</code>，而当 cache miss 时，会先调用 <code>callback</code> 编译出新的 CodeObject，然后将其存入 cache，最后再跑 <code>eval_custom_code</code>。</li></ul> <p>值得注意的是，如果调用 <code>callback</code> 返回的是 <code>None</code> 时，那么就表示编译失败，此时会将 cache 设置为 <code>SKIP_CODE</code>，并且直接跑 <code>eval_frame_default</code>，而且之后所有的调用都会直接跑 <code>eval_frame_default</code>。即只要有一次编译失败，该函数的之后所有的调用都会直接跑原生字节码。不过这明显是合理的，因为对于一个函数而言，编译失败大概率意味着这个函数是不适合编译加速的，那么之后即便是不同的输入也不会再编译了。</p> <p><code>eval_custom_code</code> 的实现很简单，就是基于原有 FrameObject 创建一个新的，在创建时使用编译后的 CodeObject 即可，最后会将新的 FrameObject 传入 <code>eval_frame_default</code> 来执行。</p> <p>也就是说 Dynamo 的 Eval Frame 只会做 CodeObject 的转换，最后还是会让 Python 解释器来实际执行。</p> <h2 id="字节码模拟执行"><a href="#字节码模拟执行" class="header-anchor">#</a> 字节码模拟执行</h2> <p>那么在 callback 里具体是如何去进行字节码变换的呢？Dynamo 是通过模拟执行 + Codegen 的方式来实现的。在模拟执行时，Dynamo 会收集需要的信息，以在 Codegen 时尽可能地还原 Python 的行为。</p> <h3 id="compile-流程"><a href="#compile-流程" class="header-anchor">#</a> compile 流程</h3> <p><img alt="Dynamo Compile" data-src="/assets/img/dynamo-compile.drawio.236dde09.png" loading="lazy" class="lazy"></p> <p>Dynamo 在 compile 时（也就是 callback）会将逐字节码地模拟执行，在执行过程中如果遇到无法编译的情况，就会抛出 <code>SkipFrame</code>，并在 callback 处返回 <code>None</code>，以标记该 CodeObject 不适合编译。</p> <p>若模拟执行成功，那么会根据编译得到的 OutputGraph 来生成 <code>check_fn</code>，与 Codegen 得到的 <code>code</code> 共同组成 <code>GuardedCode</code> 返回给 Eval Frame。</p> <h3 id="模拟执行流程"><a href="#模拟执行流程" class="header-anchor">#</a> 模拟执行流程</h3> <p>模拟执行是 Dynamo 的核心，它的所有行为是由 <code>InstructionTranslator</code> 来定义的。</p> <p>为了能够尽可能真实地模拟 Python 解释器的行为，<code>InstructionTranslator</code> 在初始化的时候同时初始化了模拟运行栈 <code>stack</code>、PC <code>instruction_pointer</code>、模拟块栈 <code>block_stack</code>、模拟 locals <code>symbolic_locals</code>、模拟 globals <code>symbolic_globals</code> 等诸多属性，在之后的模拟运行过程中，会不断与这些状态进行交互。</p> <p>由于是模拟执行，执行过程中是不会对原有数据进行修改的，为了做到这一点，Dynamo 会将所有栈上数据包装成 <code>VariableTracker</code>，之后所有的操作都会被 <code>VariableTracker</code> 所记录。</p> <p><code>symbolic_locals</code> 在初始化的时候便会从 <code>f_locals</code> 包装成 <code>VariableTracker</code>。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>self<span class="token punctuation">.</span>symbolic_locals <span class="token operator">=</span> collections<span class="token punctuation">.</span>OrderedDict<span class="token punctuation">(</span>
   <span class="token punctuation">(</span>
      k<span class="token punctuation">,</span>
      VariableBuilder<span class="token punctuation">(</span>self<span class="token punctuation">,</span> LocalSource<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>f_locals<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token punctuation">)</span>
   <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">vars</span>
   <span class="token keyword">if</span> k <span class="token keyword">in</span> f_locals
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>因此模拟执行的操作基本都是对 <code>VariableTracker</code> 子类实例的操作，不会影响原始数据。</p> <p>在调用 <code>InstructionTranslator.run</code> 时，Dynamo 会逐步根据字节码 opname 分发到对应的函数，比如 <code>LOAD_CONST</code> 的实现如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">LOAD_CONST</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inst<span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token comment"># For empty tuples, create empty TupleVariable</span>
   <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>inst<span class="token punctuation">.</span>argval<span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token keyword">not</span> inst<span class="token punctuation">.</span>argval<span class="token punctuation">:</span>
      self<span class="token punctuation">.</span>push<span class="token punctuation">(</span>TupleVariable<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token keyword">else</span><span class="token punctuation">:</span>
      self<span class="token punctuation">.</span>push<span class="token punctuation">(</span>ConstantVariable<span class="token punctuation">(</span>value<span class="token operator">=</span>inst<span class="token punctuation">.</span>argval<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这里很简单地将包装后的常量压入了模拟运行栈 <code>stack</code> 中。</p> <p>之后看一下稍微复杂一点的 <code>BINARY_ADD</code> 的实现：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BINARY_ADD <span class="token operator">=</span> stack_op<span class="token punctuation">(</span>operator<span class="token punctuation">.</span>add<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">stack_op</span><span class="token punctuation">(</span>fn<span class="token punctuation">:</span> typing<span class="token punctuation">.</span>Callable<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token builtin">object</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
   nargs <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>inspect<span class="token punctuation">.</span>signature<span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">.</span>parameters<span class="token punctuation">)</span>
   fn_var <span class="token operator">=</span> BuiltinVariable<span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
   <span class="token decorator annotation punctuation">@functools<span class="token punctuation">.</span>wraps</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
   <span class="token keyword">def</span> <span class="token function">impl</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span> <span class="token string">&quot;InstructionTranslatorBase&quot;</span><span class="token punctuation">,</span> inst<span class="token punctuation">:</span> Instruction<span class="token punctuation">)</span><span class="token punctuation">:</span>
      self<span class="token punctuation">.</span>push<span class="token punctuation">(</span>fn_var<span class="token punctuation">.</span>call_function<span class="token punctuation">(</span>self<span class="token punctuation">,</span> self<span class="token punctuation">.</span>popn<span class="token punctuation">(</span>nargs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token keyword">return</span> impl
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这里先用 builtin 函数（这里是 <code>operator.add</code>）创建 <code>BuiltinVariable</code>，然后弹栈两个操作数，传入新的 Variable 调用 <code>call_function</code>，并将结果压栈。</p> <p>那么这里 <code>call_function</code> 做了什么呢？由于这里的实现细节比较多，这里只考虑几种简单的情况：</p> <ul><li>当两个参数都是常量（<code>ConstantVariable</code>），并且可以常量折叠，则直接返回折叠后的 <code>ConstantVariable</code></li> <li>如果有参数是 Tensor（<code>TensorVariable</code>），那么创建 FX Proxy，开始 FX Graph 组网</li></ul> <p>比如对于如下的代码：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> torch
<span class="token decorator annotation punctuation">@torch<span class="token punctuation">.</span>compile</span>
<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
   x <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token number">1</span>
   y <span class="token operator">=</span> y <span class="token operator">-</span> <span class="token number">1</span>
   x <span class="token operator">=</span> x <span class="token operator">+</span> y
   <span class="token keyword">return</span> x
x <span class="token operator">=</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
y <span class="token operator">=</span> <span class="token number">2</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>foo<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>实际模拟执行可能会类似于下图：</p> <p><img alt="Dynamo Simulate Execution" data-src="/assets/img/dynamo-simulate-execution.drawio.e6e42641.png" loading="lazy" class="lazy"></p> <p>在执行 <code>BINARY_ADD</code> 前后，<code>stack</code> 弹出两个 Variable，并放入一个新的 Variable，同时 FX Graph 也进行了组网。</p> <p>由于 <code>BuiltinVariable</code> 表示一个 builtin 操作，是有很多操作是会构建此 Variable 的，比如各种魔法函数，当然 <code>print</code> 也是，但是 <code>call_function</code> 时并没有 <code>print</code> 的处理方式，因此会抛出 <code>Unsupported</code> 异常打断子图。</p> <h3 id="子图打断"><a href="#子图打断" class="header-anchor">#</a> 子图打断</h3> <p>在整个代码运行过程中，主要有以下三种情况会打断子图，触发子图编译：</p> <ul><li>当遇到 <code>RETURN_VALUE</code> 时</li> <li>当遇到跳转指令时，且跳转条件是 Tensor（<code>TensorVariable</code>）时</li> <li>当内部任意时刻抛出 <code>Unsupported</code> Error 时</li></ul> <p>对于遇到 <code>Unsupported</code> Error 时，Dynamo 会将当前的子图打断，并将之后的代码抽到一个新的函数中，即交由下一个 Frame 来处理。</p> <h3 id="跳转指令的处理"><a href="#跳转指令的处理" class="header-anchor">#</a> 跳转指令的处理</h3> <p>跳转指令的处理会稍微复杂一些，Dynamo 会在遇到 JUMP 指令，且跳转条件是 Tensor 的时候，触发子图编译，并将跳转分支分别提取成两个函数，分别对原有的两个分支进行替换。</p> <p>下面直接通过例子来说明一下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token decorator annotation punctuation">@torch<span class="token punctuation">.</span>compile</span>
<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token keyword">if</span> x <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
      y <span class="token operator">+=</span> <span class="token number">1</span>
   <span class="token keyword">else</span><span class="token punctuation">:</span>
      y <span class="token operator">-=</span> <span class="token number">1</span>
   <span class="token keyword">return</span> y
<span class="token keyword">print</span><span class="token punctuation">(</span>foo<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>对于如上代码来说，由于跳转条件是一个 Tensor，因此是会发生子图打断的，对于函数 <code>foo</code> 而言，编译前后的字节码分别如下：</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>Before:
 42           0 LOAD_FAST                0 (x)
              2 LOAD_CONST               1 (0)
              4 COMPARE_OP               4 (&gt;)
              6 POP_JUMP_IF_FALSE       10 (to 20)
 43           8 LOAD_FAST                1 (y)
             10 LOAD_CONST               2 (1)
             12 INPLACE_ADD
             14 STORE_FAST               1 (y)
 46          16 LOAD_FAST                1 (y)
             18 RETURN_VALUE
 45     &gt;&gt;   20 LOAD_FAST                1 (y)
             22 LOAD_CONST               2 (1)
             24 INPLACE_SUBTRACT
             26 STORE_FAST               1 (y)
 46          28 LOAD_FAST                1 (y)
             30 RETURN_VALUE
After:
 40           0 LOAD_GLOBAL              0 (__compiled_fn_0)
              2 LOAD_FAST                0 (x)
              4 CALL_FUNCTION            1
              6 UNPACK_SEQUENCE          1
              8 POP_JUMP_IF_FALSE        9 (to 18)
             10 LOAD_GLOBAL              1 (__resume_at_8_1)
             12 LOAD_FAST                1 (y)
             14 CALL_FUNCTION            1
             16 RETURN_VALUE
        &gt;&gt;   18 LOAD_GLOBAL              2 (__resume_at_20_2)
             20 LOAD_FAST                1 (y)
             22 CALL_FUNCTION            1
             24 RETURN_VALUE
__resume_at_8_1:
 42           0 JUMP_ABSOLUTE            5 (to 10)
              2 LOAD_FAST                1 (x)
              4 LOAD_CONST               1 (0)
              6 COMPARE_OP               4 (&gt;)
              8 POP_JUMP_IF_FALSE       11 (to 22)
 43     &gt;&gt;   10 LOAD_FAST                0 (y)
             12 LOAD_CONST               2 (1)
             14 INPLACE_ADD
             16 STORE_FAST               0 (y)
 46          18 LOAD_FAST                0 (y)
             20 RETURN_VALUE
 45     &gt;&gt;   22 LOAD_FAST                0 (y)
             24 LOAD_CONST               2 (1)
             26 INPLACE_SUBTRACT
             28 STORE_FAST               0 (y)
 46          30 LOAD_FAST                0 (y)
             32 RETURN_VALUE
__resume_at_20_2:
 42           0 JUMP_ABSOLUTE           11 (to 22)
              2 LOAD_FAST                1 (x)
              4 LOAD_CONST               1 (0)
              6 COMPARE_OP               4 (&gt;)
              8 POP_JUMP_IF_FALSE       11 (to 22)
             10 LOAD_FAST                0 (y)
             12 LOAD_CONST               2 (1)
             14 INPLACE_ADD
             16 STORE_FAST               0 (y)
             18 LOAD_FAST                0 (y)
             20 RETURN_VALUE
 45     &gt;&gt;   22 LOAD_FAST                0 (y)
             24 LOAD_CONST               2 (1)
             26 INPLACE_SUBTRACT
             28 STORE_FAST               0 (y)
 46          30 LOAD_FAST                0 (y)
             32 RETURN_VALUE
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br></div></div><p>字节码上可能并不是很清晰，这里用一张图来说明下：</p> <p><img alt="Dynamo Resume" data-src="/assets/img/dynamo-resume.drawio.9d36d118.png" loading="lazy" class="lazy"></p> <p>可以看到，生成的字节码中，一方面包含了子图编译的函数，另一方面，将是否跳转对应的两个分支抽取到了新的 resume 函数中，这样在这个函数，根据 Tensor 值来跳转的问题就解决了，下个分支的问题，交由下个 Frame 处理即可，这样问题就分解了。</p> <p>值得注意的是，在字节码层面，我们不应该去过分的苛求还原原有的分支结构，在这里我们只会注意跳转的与否，如果不跳转，就是走 BLOCK 1 + BLOCK 2，如果跳转，就是走 BLOCK 1，在字节码层面这是很清晰、很明确的事情。这样的话，我们就无需再去考虑它从代码层面是 if-else 还是 for/while-loop，因为在字节码层面他们都是 JUMP，都会归结成这一种模式。那嵌套的怎么办？嵌套在字节码层面本质就是多个 JUMP 指令，但对于我们来说，只需要关注第一个 JUMP 就可以了，第二个 JUMP 已经移交到下个 Frame 处理了。</p> <h2 id="代码生成"><a href="#代码生成" class="header-anchor">#</a> 代码生成</h2> <p>从端到端来说，整个 Dynamo 做的事就是 <code>code</code> -&gt; <code>code</code>，也就是说整个过程一定是一种代码变换，而我们之前模拟执行的主要目的是收集信息，之后还需要 Codegen 来生成需要的代码。</p> <p>Dynamo 的代码生成部分大多都是非常简单易懂的，resume 部分生成的代码已经在上面展示过了，下面展示下子图编译的代码生成。</p> <h3 id="子图编译代码生成"><a href="#子图编译代码生成" class="header-anchor">#</a> 子图编译代码生成</h3> <p>子图编译时的代码生成主要包含以下几步：</p> <ul><li>将 FX Graph 编译成函数，这个过程会调用用户提供的 compiler backend，并将该函数挂到 globals 里</li> <li>在生成字节码里加上从 globals 里 LOAD 刚刚编译好的函数的字节码</li> <li>在生成字节码里加上 LOAD 需要传入的参数，注意所有参数都是知道来源（Source）的，因此可以 Codegen 出需要的 LOAD 指令</li> <li>在生成字节码里加上 CALL_FUNCTION 指令，调用编译好的函数</li> <li>在生成字节码里加上 SideEffects 的处理</li></ul> <p>我们从一个示例来看这个过程：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value
<span class="token decorator annotation punctuation">@torch<span class="token punctuation">.</span>compile</span>
<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    x<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">return</span> x<span class="token punctuation">.</span>value <span class="token operator">+</span> y<span class="token punctuation">.</span>value
foo<span class="token punctuation">(</span>A<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> A<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>生成的代码大致如下（因为生成的代码是字节码层面的，这里手动还原成 Python 代码）：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># 这个函数只有字节码，没有 Python 源码，这是手动翻译过来的</span>
<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
   out <span class="token operator">=</span> compiled_fn<span class="token punctuation">(</span>y<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
   out<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment"># 这里直接放在栈上没有取走，所以最后 return 的时候会 return 这个，这里尽可能还原字节码顺序，不把这个放在 return 后面</span>
   x<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">4</span> <span class="token comment"># SideEffects 生成的</span>
   <span class="token keyword">return</span> <span class="token comment"># out[0]</span>
<span class="token comment"># 这个函数是 FX graph 生成的</span>
<span class="token keyword">def</span> <span class="token function">compiled_fn</span><span class="token punctuation">(</span>y_value<span class="token punctuation">)</span><span class="token punctuation">:</span>
   add <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">+</span> y_value
   <span class="token keyword">return</span> <span class="token punctuation">(</span>add<span class="token punctuation">,</span> <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>值得注意的是，这里两个函数里包含了常量 4，这个 4 是 <code>x.value += 1</code> 生成的，也就是说这个输入已经硬编码在输出的代码里了，为了保证其正确性，Dynamo 在 Guard 里包含了 <code>L['x'].value == 3</code> 的检查项，也就是说只要 <code>x.value != 3</code> 就会触发重新编译。</p> <h3 id="source-管理"><a href="#source-管理" class="header-anchor">#</a> Source 管理</h3> <p>在上面的代码生成过程中，我们提到了 Source，我们可以利用它来重新生成 LOAD 参数的代码，这里看一下 Source 是如何管理的。</p> <p>在模拟执行的初期，我们从 <code>f_locals</code> 构建 <code>symbolic_locals</code> 的时候，就会设置生成的 VariableTracker，使其 Source 为 LocalSource，这样就可以知道这些栈上元素最初是从 <code>f_locals</code> 里得到的，当然我们就可以生成直接从 <code>f_locals</code> 里 LOAD 它的指令了。</p> <p>对于一些复合操作，比如 <code>x.y</code>，在 VariableTracker 的构建过程中，会将 Source 属性进行传播，比如这里 <code>x.y</code> 对应的 VariableTracker 的 Source 可能就是 <code>AttrSource(base=LocalSource(local_name='x'), member='y')</code>，我们同样也是可以很方便地通过它来生成这个 getattr 操作对应的 Bytecode。</p> <h3 id="guard-管理"><a href="#guard-管理" class="header-anchor">#</a> Guard 管理</h3> <p>为了保护生成的代码在下一次调用时是可用的，Dynamo 会为每个生成的代码都加上一个 Guard，这个 Guard 是一个 lambda 函数，形式大概类似 <code>lambda L: ___guarded_code.valid and not ___are_deterministic_algorithms_enabled() and ___check_tensors(L['x'], L['y'])</code>，在 Eval Frame 部分我们已经知道了，这个函数会将 <code>f_locals</code> 作为参数，因此，这里的 <code>L['x']</code>、<code>L['y']</code> 即表示输入参数中的 <code>x</code> 和 <code>y</code>。</p> <p>比如对于如下代码：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value
<span class="token decorator annotation punctuation">@torch<span class="token punctuation">.</span>compile</span>
<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> x<span class="token punctuation">.</span>value <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">:</span>
        y <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        y <span class="token operator">-=</span> <span class="token number">1</span>
    <span class="token keyword">return</span> y
<span class="token keyword">print</span><span class="token punctuation">(</span>foo<span class="token punctuation">(</span>A<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>最后会生成如下的 Guard：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">lambda</span> L<span class="token punctuation">:</span> ___guarded_code<span class="token punctuation">.</span>valid <span class="token keyword">and</span> ___check_type_id<span class="token punctuation">(</span>L<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4882921328</span><span class="token punctuation">)</span> <span class="token keyword">and</span> ___check_type_id<span class="token punctuation">(</span>L<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token number">4299954872</span><span class="token punctuation">)</span> <span class="token keyword">and</span> L<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">5</span> <span class="token keyword">and</span> <span class="token keyword">not</span> ___are_deterministic_algorithms_enabled<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">and</span> ___check_tensors<span class="token punctuation">(</span>L<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这里主要检查了如下几项：</p> <ul><li><code>x</code> 类型是 <code>A</code></li> <li><code>x.value</code> 类型是 <code>int</code>，这里 <code>x.value</code> 的代码同样可以从 Source 生成</li> <li><code>x.value</code> 值为 5</li> <li>关于 <code>y</code> 的一系列 Tensor 检查，这包含了 <code>dtype</code>、<code>device</code>、<code>requires_grad</code>、<code>ndim</code> 等属性</li></ul> <p>Guard 是有传播机制的，比如 <code>z = x + y</code>，新生成的 <code>z</code> 的 Guard 是 <code>x</code> 和 <code>y</code> 是 Guard 的总和，这可以通过 <code>VariableTracker.propagate</code> 在不同 VariableTracker 之间进行传播，这就确保了值的依赖关系是可以保持的。</p> <h3 id="sideeffects-管理"><a href="#sideeffects-管理" class="header-anchor">#</a> SideEffects 管理</h3> <p>由于在模拟执行过程中，我们是可以跟踪任意时刻对于任何变量的操作的，因此任何副作用都是可追踪的，在遇到存在副作用的操作时，我们只需要将其记录下来，并在最终生成的代码里生成相应的副作用代码即可。</p> <p>比如对于如下明显有副作用的代码：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token decorator annotation punctuation">@torch<span class="token punctuation">.</span>compile</span>
<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
   x<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
   <span class="token keyword">return</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>
x <span class="token operator">=</span> <span class="token punctuation">[</span>torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>foo<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>生成的代码大概如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
   out <span class="token operator">=</span> compiled_fn<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   out<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
   x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment"># SideEffects</span>
   <span class="token keyword">return</span> <span class="token comment"># out[0]</span>
<span class="token keyword">def</span> <span class="token function">compiled_fn</span><span class="token punctuation">(</span>x_0<span class="token punctuation">)</span><span class="token punctuation">:</span>
   add <span class="token operator">=</span> x_0 <span class="token operator">+</span> <span class="token number">1</span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span>add<span class="token punctuation">,</span> <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>其中 <code>x[:] = [x[0], 1]</code> 即恢复副作用影响的代码，Dynamo 会将原来的 <code>x</code> inplace 地全部替换成新的结果 <code>[x[0], 1]</code></p> <h2 id="references"><a href="#references" class="header-anchor">#</a> References</h2> <ol><li><a href="https://peps.python.org/pep-0523/" target="_blank" rel="noopener noreferrer">PEP 523 – Adding a frame evaluation API to CPython<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>TorchDynamo Source: <a href="https://github.com/pytorch/pytorch/tree/main/torch/csrc/dynamo" target="_blank" rel="noopener noreferrer">C side<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://github.com/pytorch/pytorch/tree/main/torch/_dynamo" target="_blank" rel="noopener noreferrer">Python side<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://pytorch.org/docs/stable/dynamo/guards-overview.html" target="_blank" rel="noopener noreferrer">TorchDynamo Overview - Guards Overview<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://nanguage.gitbook.io/inside-python-vm-cn/" target="_blank" rel="noopener noreferrer">深入理解 Python 虚拟机<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol></div></article> <section class="post-meta main-div" data-v-3c27fa5a><section class="post-date clearfix" data-v-3c27fa5a><span class="create-date" data-v-3c27fa5a>
      发布时间 : 2023-04-22
    </span> <span class="update-date" data-v-3c27fa5a>
      最后修改 : 2023-08-28
    </span></section> <section class="post-links" data-v-3c27fa5a><a href="/posts/2022/09/21/moefy-paddle-dx-improvements.html" class="post-link" data-v-3c27fa5a>
      上一篇 : 让 Paddle 更可爱——开发者体验提升计划
    </a> <a href="/posts/2023/08/27/python311-instruction-specializing.html" class="post-link" data-v-3c27fa5a>
      下一篇 : Python 3.11 核心加速原理——指令特化
    </a></section></section> <!----></div></main> <aside class="aside" data-v-5e296355><div class="info-card main-div" data-v-d24226c8 data-v-5e296355><div class="info-card-header" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/info-bg.webp);" data-v-d24226c8><img src="/avatar.jpg" alt="喵ック" class="info-avatar" data-v-d24226c8></div> <div class="info-card-body" data-v-d24226c8><section class="info-nickname" data-v-d24226c8>
      喵ック
    </section> <section class="info-desc" data-v-d24226c8>可爱是第一驱动力～</section> <section class="info-contact" data-v-d24226c8><section data-v-d24226c8><span title="Beijing, China" data-v-d24226c8 data-v-d24226c8><svg class="icon" style="font-size:1em;" data-v-d24226c8 data-v-d24226c8><title data-v-d24226c8 data-v-d24226c8>Beijing, China</title><use xlink:href="#icon-location" data-v-d24226c8 data-v-d24226c8></use></svg><span class="info-text" data-v-d24226c8 data-v-d24226c8>
          Beijing, China
        </span></span></section> <section data-v-d24226c8><span title="PaddlePaddle" data-v-d24226c8 data-v-d24226c8><svg class="icon" style="font-size:1em;" data-v-d24226c8 data-v-d24226c8><title data-v-d24226c8 data-v-d24226c8>PaddlePaddle</title><use xlink:href="#icon-organization" data-v-d24226c8 data-v-d24226c8></use></svg><span class="info-text" data-v-d24226c8 data-v-d24226c8>
          PaddlePaddle
        </span></span></section> <section data-v-d24226c8><a href="mailto:sigure.qaq@gmail.com" title="sigure.qaq@gmail.com" data-v-d24226c8 data-v-d24226c8><svg class="icon" style="font-size:1em;" data-v-d24226c8 data-v-d24226c8><title data-v-d24226c8 data-v-d24226c8>sigure.qaq@gmail.com</title><use xlink:href="#icon-email" data-v-d24226c8 data-v-d24226c8></use></svg><span class="info-text" data-v-d24226c8 data-v-d24226c8>
          sigure.qaq@gmail.com
        </span></a></section></section></div> <div class="info-card-footer" data-v-d24226c8><section class="info-sns clearfix" data-v-d24226c8><a href="https://github.com/SigureMo" target="_blank" class="sns-link" data-v-d24226c8><span title="GitHub: SigureMo" class="sns-icon" data-v-d24226c8 data-v-d24226c8><svg class="icon" style="font-size:1.5em;" data-v-d24226c8 data-v-d24226c8><title data-v-d24226c8 data-v-d24226c8>GitHub: SigureMo</title><use xlink:href="#icon-github" data-v-d24226c8 data-v-d24226c8></use></svg></span></a></section></div></div> <div class="post-nav-card main-div" style="position:relative;top:0;width:0px;" data-v-5e296355><div class="post-nav-contents"><svg class="icon"><title>book</title><use xlink:href="#icon-book"></use></svg> <span>文章目录</span> <div class="post-nav-toc"><ul><li><a href="/posts/2023/04/22/decomposing-torch-dynamo.html#什么是-torchdynamo">什么是 TorchDynamo</a><ul><li><a href="/posts/2023/04/22/decomposing-torch-dynamo.html#torchdynamo-总览">TorchDynamo 总览</a></li><li><a href="/posts/2023/04/22/decomposing-torch-dynamo.html#torchdynamo-编译过程">TorchDynamo 编译过程</a></li></ul></li><li><a href="/posts/2023/04/22/decomposing-torch-dynamo.html#eval-frame-原理和执行流程">Eval Frame 原理和执行流程</a><ul><li><a href="/posts/2023/04/22/decomposing-torch-dynamo.html#frameobject-和-codeobject">FrameObject 和 CodeObject</a></li><li><a href="/posts/2023/04/22/decomposing-torch-dynamo.html#pep-523">PEP 523</a></li><li><a href="/posts/2023/04/22/decomposing-torch-dynamo.html#eval-frame-流程">Eval Frame 流程</a></li></ul></li><li><a href="/posts/2023/04/22/decomposing-torch-dynamo.html#字节码模拟执行">字节码模拟执行</a><ul><li><a href="/posts/2023/04/22/decomposing-torch-dynamo.html#compile-流程">compile 流程</a></li><li><a href="/posts/2023/04/22/decomposing-torch-dynamo.html#模拟执行流程">模拟执行流程</a></li><li><a href="/posts/2023/04/22/decomposing-torch-dynamo.html#子图打断">子图打断</a></li><li><a href="/posts/2023/04/22/decomposing-torch-dynamo.html#跳转指令的处理">跳转指令的处理</a></li></ul></li><li><a href="/posts/2023/04/22/decomposing-torch-dynamo.html#代码生成">代码生成</a><ul><li><a href="/posts/2023/04/22/decomposing-torch-dynamo.html#子图编译代码生成">子图编译代码生成</a></li><li><a href="/posts/2023/04/22/decomposing-torch-dynamo.html#source-管理">Source 管理</a></li><li><a href="/posts/2023/04/22/decomposing-torch-dynamo.html#guard-管理">Guard 管理</a></li><li><a href="/posts/2023/04/22/decomposing-torch-dynamo.html#sideeffects-管理">SideEffects 管理</a></li></ul></li><li><a href="/posts/2023/04/22/decomposing-torch-dynamo.html#references">References</a></li></ul></div></div> <!----></div></aside></div> <footer class="footer" data-v-a9a89600><p class="footer-sns-links" data-v-a9a89600><a href="https://github.com/SigureMo" target="_blank" class="sns-link" data-v-a9a89600><span title="GitHub: SigureMo" class="sns-icon" data-v-a9a89600 data-v-a9a89600><svg class="icon" style="font-size:25px;" data-v-a9a89600 data-v-a9a89600><title data-v-a9a89600 data-v-a9a89600>GitHub: SigureMo</title><use xlink:href="#icon-github" data-v-a9a89600 data-v-a9a89600></use></svg></span></a></p> <p class="footer-text" data-v-a9a89600><span data-v-a9a89600>Powered by </span> <a href="https://github.com/vuejs/vuepress" target="_blank" data-v-a9a89600>
      VuePress
    </a> <span data-v-a9a89600> | </span> <a href="https://github.com/meteorlxy/vuepress-theme-meteorlxy" target="_blank" data-v-a9a89600>
        meteorlxy
      </a></p> <p class="footer-text" data-v-a9a89600>Copyright 2018-present <a href="https://github.com/SigureMo" target="_blank">Nyakku</a> | <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA-4.0</a></p></footer></div><div class="global-ui"><!----><!----><!----><canvas id="vuepress-canvas-ribbon"></canvas><canvas id="vuepress-canvas-cursor"></canvas><div></div><div id="goTop" class="hide-cat" data-v-f6babb38></div><APlayer audio="" fixed="true" theme="#b7daff" loop="loop" order="list" preload="metadata" volume="0.7" mutex="true" lrc-type="3" list-max-height="250" storage-name="vuepress-plugin-meting" id="aplayer-fixed"></APlayer></div></div>
    <script src="/assets/js/app.6ffe9626.js" defer></script><script src="/assets/js/7.f870edc6.js" defer></script><script src="/assets/js/15.bc180d2d.js" defer></script><script src="/assets/js/23.f4ab9440.js" defer></script>
  </body>
</html>
