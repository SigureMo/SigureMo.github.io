<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Python 3.11 核心加速原理——指令特化 | Notev</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/favicon152.png">
    <link rel="mask-icon" href="/icons/favicon152.png" color="#3eaf7c">
    <link rel="alternate" type="application/rss+xml" href="https://nyakku.moe/rss.xml" title="Notev RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://nyakku.moe/feed.atom" title="Notev Atom Feed">
    <link rel="alternate" type="application/json" href="https://nyakku.moe/feed.json" title="Notev JSON Feed">
    <meta name="description" content="一个小透明的透明世界">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta property="og:url" content="https://nyakku.moe">
    <meta property="og:site_name" content="Notev">
    <meta property="og:image" content="/bg.webp">
    <meta property="og:description" content="一个小透明的透明世界">
    <meta property="og:title" content="Notev">
    <meta name="theme-color" content="#222222">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/favicon144.png">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/assets/css/0.styles.ae4bc851.css" as="style"><link rel="preload" href="/assets/js/app.6ffe9626.js" as="script"><link rel="preload" href="/assets/js/7.f870edc6.js" as="script"><link rel="preload" href="/assets/js/34.f5dd158b.js" as="script"><link rel="preload" href="/assets/js/23.f4ab9440.js" as="script"><link rel="prefetch" href="/assets/js/1.e3010140.js"><link rel="prefetch" href="/assets/js/10.ba769f1e.js"><link rel="prefetch" href="/assets/js/12.e6a9d16c.js"><link rel="prefetch" href="/assets/js/13.cbe40062.js"><link rel="prefetch" href="/assets/js/14.de8176b8.js"><link rel="prefetch" href="/assets/js/15.bc180d2d.js"><link rel="prefetch" href="/assets/js/16.77ffbcb1.js"><link rel="prefetch" href="/assets/js/17.a1263238.js"><link rel="prefetch" href="/assets/js/18.ccc050d1.js"><link rel="prefetch" href="/assets/js/19.a175bc31.js"><link rel="prefetch" href="/assets/js/2.da6cc646.js"><link rel="prefetch" href="/assets/js/20.21f2579f.js"><link rel="prefetch" href="/assets/js/21.a45600e0.js"><link rel="prefetch" href="/assets/js/22.51d6df0c.js"><link rel="prefetch" href="/assets/js/24.41e79c9e.js"><link rel="prefetch" href="/assets/js/25.4dc327c4.js"><link rel="prefetch" href="/assets/js/26.219d9641.js"><link rel="prefetch" href="/assets/js/27.b5a79c37.js"><link rel="prefetch" href="/assets/js/28.8ae7e0e6.js"><link rel="prefetch" href="/assets/js/29.64423761.js"><link rel="prefetch" href="/assets/js/3.27a8c8d5.js"><link rel="prefetch" href="/assets/js/30.622bb606.js"><link rel="prefetch" href="/assets/js/31.f41defd2.js"><link rel="prefetch" href="/assets/js/32.4ac19872.js"><link rel="prefetch" href="/assets/js/33.0a79b200.js"><link rel="prefetch" href="/assets/js/35.6b94bddf.js"><link rel="prefetch" href="/assets/js/36.1e466a55.js"><link rel="prefetch" href="/assets/js/37.01407288.js"><link rel="prefetch" href="/assets/js/38.b3f1fe79.js"><link rel="prefetch" href="/assets/js/39.7290bc98.js"><link rel="prefetch" href="/assets/js/4.41086855.js"><link rel="prefetch" href="/assets/js/40.91deb8af.js"><link rel="prefetch" href="/assets/js/41.ccf520e8.js"><link rel="prefetch" href="/assets/js/42.c7bd3d1a.js"><link rel="prefetch" href="/assets/js/43.3c8f205d.js"><link rel="prefetch" href="/assets/js/44.7ff432ec.js"><link rel="prefetch" href="/assets/js/45.089b4679.js"><link rel="prefetch" href="/assets/js/46.8dd233b3.js"><link rel="prefetch" href="/assets/js/47.a86d6e2d.js"><link rel="prefetch" href="/assets/js/5.ff46fbd2.js"><link rel="prefetch" href="/assets/js/6.309dd07b.js"><link rel="prefetch" href="/assets/js/8.4a2e364b.js"><link rel="prefetch" href="/assets/js/9.e60d35ed.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ae4bc851.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-meteorlxy"><header class="header" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/bg.webp);" data-v-548d63b6><div data-v-2ce53547 data-v-548d63b6><nav class="navbar" data-v-2ce53547><div class="container" data-v-2ce53547><a href="/" class="router-link-active" data-v-2ce53547><span class="navbar-site-name" data-v-2ce53547>
          Notev
        </span></a> <div class="navbar-toggler" data-v-2ce53547><svg class="icon" style="font-size:1.2em;" data-v-2ce53547 data-v-2ce53547><title data-v-2ce53547 data-v-2ce53547>menu</title><use xlink:href="#icon-menu" data-v-2ce53547 data-v-2ce53547></use></svg></div> <div class="navbar-links" data-v-2ce53547><a href="/" class="navbar-link" data-v-2ce53547>
            Home
          </a><a href="/posts/" class="navbar-link router-link-active" data-v-2ce53547>
            Posts
          </a><a href="/friends.html" class="navbar-link" data-v-2ce53547>
            Friends
          </a><a href="/about.html" class="navbar-link" data-v-2ce53547>
            About
          </a><a href="https://github.com/SigureMo/notev" target="_blank" rel="noopener noreferrer" class="navbar-link" data-v-2ce53547><span data-v-2ce53547>GitHub</span> <span data-v-2ce53547><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div></div></nav> <div class="navbar-holder" style="display:none;" data-v-2ce53547></div></div> <div class="banner" data-v-554dc8f4 data-v-548d63b6 data-v-548d63b6><div class="container" data-v-554dc8f4><div class="center" data-v-554dc8f4><h1 data-v-554dc8f4 data-v-548d63b6>
          Python 3.11 核心加速原理——指令特化
        </h1></div></div></div></header> <div class="container clearfix show-aside" data-v-5e296355 data-v-5e296355><main class="main" data-v-5e296355><div class="post" data-v-5e296355 data-v-5e296355><section class="post-meta main-div" data-v-3c27fa5a><section class="post-date clearfix" data-v-3c27fa5a><span class="create-date" data-v-3c27fa5a>
      发布时间 : 2023-08-27
    </span> <span class="update-date" data-v-3c27fa5a>
      最后修改 : 2023-08-28
    </span></section> <section class="post-links" data-v-3c27fa5a><a href="/posts/2023/04/22/decomposing-torch-dynamo.html" class="post-link" data-v-3c27fa5a>
      上一篇 : 哇，好复杂的 TorchDynamo，我们拆开看看吧～
    </a> <!----></section></section> <article class="main-div"><div class="post-content content content__default"><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>近期在做一些 Python 3.11 的适配工作，结果 Python 3.11 的改动实在是太多了，针对一个一个问题解决并不利于理解 Python 3.11 改动的本质，因此这里稍微花了点时间来调研和整理 Python 3.11 的核心变化。</p></div> <h2 id="faster-cpython-不断加速的-cpython"><a href="#faster-cpython-不断加速的-cpython" class="header-anchor">#</a> Faster CPython——不断加速的 CPython</h2> <p>自从几年前 <a href="https://github.com/faster-cpython" target="_blank" rel="noopener noreferrer">Faster CPython<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 发起以来，CPython 的开发者们一直致力于提升 CPython 的性能，而 Python 3.11 则是 Faster CPython 的一个里程碑，在 <a href="https://github.com/python/pyperformance" target="_blank" rel="noopener noreferrer">pyperformance<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> benchmark 上平均比 Python 3.10 快 25%。</p> <p>从 <a href="https://docs.python.org/3/whatsnew/3.11.html#faster-cpython" target="_blank" rel="noopener noreferrer">Python 3.11 Release Notes - Faster CPython<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 一节中我们能找到 Python 3.11 中主要的加速点，Release Notes 中将其分为「启动加速」和「运行时加速」两部分。</p> <p>「启动加速」主要就是将核心模块进行「frozen」，我们可以通过分别打印 Python 3.10 和 Python 3.11 的部分核心模块来对比：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> os
<span class="token keyword">print</span><span class="token punctuation">(</span>os<span class="token punctuation">)</span>
<span class="token comment"># Output in Python 3.10</span>
<span class="token comment"># &lt;module 'os' from '/path/to/os.py'&gt;</span>
<span class="token comment"># Output in Python 3.11</span>
<span class="token comment"># &lt;module 'os' (frozen)&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>可以看到 Python 3.11 的 <code>os</code> 模块已经是 frozen 的了。</p> <p>关于「运行时加速」，主要包含如下几点：</p> <ul><li><strong>更加轻量和 Lazy 的 frame</strong>。简单来说就是 Python 3.11 的 frame 是更加精简的数据结构，其中去掉了调试信息和异常堆栈，因为在大多数情况下这些信息是没有必要的，如果需要原来的 FrameObject 则可以 lazy 地创建，而<a href="https://devguide.python.org/internals/interpreter/#exception-table-format" target="_blank" rel="noopener noreferrer">异常信息<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>则是在编译时通过分析生成了（CodeObject 的 <code>co_exceptiontable</code>），运行时则是近乎零成本（只需要在发生异常时查表，而不需要维护异常堆栈）。</li> <li><strong>Inline 函数调用</strong>。在 Python 3.11 之前，每发生一次 Python 函数调用的同时也会创建一个 C 函数调用，这导致了 Python 函数调用会消耗 C 的调用栈。而在 Python 3.11 中，在发生 Python 函数调用时，在创建一个新的 Frame 后，会「跳转」到解释器的开始，而不是创建一个新的 C 函数调用。这里的「跳转」在代码实现中就是一个 <a href="https://github.com/python/cpython/blob/3.11/Python/ceval.c#L4764" target="_blank" rel="noopener noreferrer">goto<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li> <li><strong>特化的自适应解释器</strong>（<a href="https://peps.python.org/pep-0659/" target="_blank" rel="noopener noreferrer">PEP 659: Specializing Adaptive Interpreter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>），从标题就可以看出，这是本文要描述的重点，那么我们接下来逐渐展开吧～</li></ul> <h2 id="指令特化"><a href="#指令特化" class="header-anchor">#</a> 指令特化</h2> <p>特化是一种常见的 JIT 加速手段，对于动态语言而言，每一条看似简单的指令都可能对应着多种不同的实现，比如一个简简单单的 <code>+</code>（<code>BINARY_ADD</code>，在 Python 3.11 则是 <code>BINARY_OP +</code>），对于不同的类型，其实现是完全不同的，可能是 <code>int</code> 加，可能是 <code>float</code> 加，甚至可能执行用户自定义的 <code>__add__</code>，而判断具体执行什么的过程则带来了不小的运行时开销。</p> <p>虽然动态语言的查找是不可避免的，但是对于大多数字节码来说，其往往只对应了一种具体实现，比如 <code>a.b + c</code>，假如 <code>a.b</code> 和 <code>c</code> 都为 <code>int</code>，那么其实大概率其类型是不会变的，这被称为「类型稳定性」。虽然我们不能保证之后 <code>a.b</code> 和 <code>c</code> 类型不会变，但我们可以根据这个信息来决策之后优先选择 <code>int</code> 加这一实现，这便是特化的思想。</p> <p>Python 3.11 在解释器中引入了特化的思想，不过值得注意的是其是在字节码层面进行的，而没有编译成机器码，因此并不是 JIT（见 <a href="https://docs.python.org/3/whatsnew/3.11.html#is-there-a-jit-compiler" target="_blank" rel="noopener noreferrer">Is there a JIT compiler?<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>），但毫无疑问这借鉴了 JIT 的思想。</p> <h2 id="额外信息的存储-inline-cache"><a href="#额外信息的存储-inline-cache" class="header-anchor">#</a> 额外信息的存储——Inline Cache</h2> <p>特化需要运行时的统计信息，Python 3.11 将这些信息存储在字节码中，即为 Inline Cache。与 Python 3.10 不同，Python 3.11 的字节码序列中为特化指令预留了 Inline Cache 的位置，比如 <code>BINARY_OP</code> 除去操作码和操作数 2 bytes 以外，还包含 2 bytes 的 Inline Cache，我们可以通过如下实验来验证：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> dis
<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b
dis<span class="token punctuation">.</span>dis<span class="token punctuation">(</span>foo<span class="token punctuation">)</span>
<span class="token comment"># Output in Python 3.10</span>
<span class="token comment">#   5           0 LOAD_FAST                0 (a)</span>
<span class="token comment">#               2 LOAD_FAST                1 (b)</span>
<span class="token comment">#               4 BINARY_ADD</span>
<span class="token comment">#               6 RETURN_VALUE</span>
<span class="token comment"># Output in Python 3.11</span>
<span class="token comment">#   4           0 RESUME                   0</span>
<span class="token comment">#</span>
<span class="token comment">#   5           2 LOAD_FAST                0 (a)</span>
<span class="token comment">#               4 LOAD_FAST                1 (b)</span>
<span class="token comment">#               6 BINARY_OP                0 (+)</span>
<span class="token comment">#              10 RETURN_VALUE</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>可以看到 Python 3.10 每个字节码都占据 2 bytes，而 Python 3.11 中 <code>BINARY_OP</code> 则占据了 4 bytes，这其中就包含了 2 bytes 的 Inline Cache。</p> <p>Python 3.11 全部的特化指令如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// https://github.com/python/cpython/blob/3.11/Include/internal/pycore_opcode.h#L41-L53</span>
<span class="token keyword">const</span> <span class="token class-name">uint8_t</span> _PyOpcode_Caches<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>BINARY_SUBSCR<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>STORE_SUBSCR<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>UNPACK_SEQUENCE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>STORE_ATTR<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>LOAD_ATTR<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>COMPARE_OP<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>LOAD_GLOBAL<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>BINARY_OP<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>LOAD_METHOD<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>PRECALL<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>CALL<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>当然其实这里展示的是 CPython 各个指令的 Inline Cache 长度，Inline Cache 以 <code>_Py_CODEUNIT</code> 为基本单元，<code>_Py_CODEUNIT</code> 的大小则是 2 bytes，因此 <code>BINARY_OP</code> 对应的 1 即代表其 Inline Cache 大小为 2 bytes。再以 <code>LOAD_ATTR</code> 为例的话，其 Inline Cache 大小为 4*2=8 bytes，加上其本身共 10 bytes。</p> <p>关于 Inline Cache 的数据结构我们也可以在 <a href="https://github.com/python/cpython/blob/3.11/Include/internal/pycore_code.h" target="_blank" rel="noopener noreferrer">cpython 3.11 pycore_code.h<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中找到，这里同样以 <code>LOAD_ATTR</code> 为例：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// https://github.com/python/cpython/blob/3.11/Include/internal/pycore_code.h#L55-L61</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    _Py_CODEUNIT counter<span class="token punctuation">;</span>
    _Py_CODEUNIT version<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    _Py_CODEUNIT index<span class="token punctuation">;</span>
<span class="token punctuation">}</span> _PyAttrCache<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INLINE_CACHE_ENTRIES_LOAD_ATTR</span> <span class="token expression"><span class="token function">CACHE_ENTRIES</span><span class="token punctuation">(</span>_PyAttrCache<span class="token punctuation">)</span></span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>可以看到它的 4 个 <code>_Py_CODEUNIT</code> 分别为 <code>counter</code>、<code>version[2]</code>、<code>index</code>，这里第一个字段固定表示计数器，对于所有特化指令是一致的，其它字段则视具体指令而定。</p> <p>从字节码布局来看是这样的：</p> <p align="center"><img src="/assets/img/inline-cache.drawio.64b35eb1.png" alt="Inline Cache" width="500px"></p> <p>在编译结束阶段，CPython 会在 Inline Cache 的位置填充 0：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// https://github.com/python/cpython/blob/3.11/Python/compile.c#L205-L231</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">write_instr</span><span class="token punctuation">(</span>_Py_CODEUNIT <span class="token operator">*</span>codestr<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">instr</span> <span class="token operator">*</span>instruction<span class="token punctuation">,</span> <span class="token keyword">int</span> ilen<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>caches<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>codestr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token function">_Py_MAKECODEUNIT</span><span class="token punctuation">(</span>CACHE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>其中<a href="https://github.com/python/cpython/blob/3.11/Include/opcode.h#L11" target="_blank" rel="noopener noreferrer">字节码 <code>CACHE</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 对应的值也是 0，因此每个 <code>_Py_CODEUNIT</code> 相当于填充了 2 bytes 的 0。</p> <p>因此在编译结束后的字节码其实看起来是这样子的：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>  4           0 RESUME                   0
  5           2 LOAD_FAST                0 (self)
              4 LOAD_ATTR                0 (a)
              6     (CACHE)              0
              8     (CACHE)              0
             10     (CACHE)              0
             12     (CACHE)              0
             14 RETURN_VALUE
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这里 <code>LOAD_ATTR</code> 后紧紧跟随了独属于它的 4 个 Inline Cache，这些 Cache 会在运行时被填充。</p> <h2 id="字节码族-特化与自适应"><a href="#字节码族-特化与自适应" class="header-anchor">#</a> 字节码族——特化与自适应</h2> <p>为了实现特化，Python 3.11 在运行时会根据 Inline Cache 的信息来原位替换原有的字节码，不过替换的字节码必须是同一「族」（family）的。比如对于编译期产生的原始 <code>LOAD_ATTR</code>，该族包含如下几条指令：</p> <ul><li>原始指令：<code>LOAD_ATTR</code></li> <li>自适应指令：<code>LOAD_ATTR_ADAPTIVE</code></li> <li>特化指令：
<ul><li><code>LOAD_ATTR_INSTANCE_VALUE</code>：一种常见的情况，其中属性存储在对象的值数组中，并且不被覆盖描述符遮蔽</li> <li><code>LOAD_ATTR_MODULE</code>：从模块 load 属性</li> <li><code>LOAD_ATTR_SLOT</code>：从 <code>__slots__</code> 加载属性</li></ul></li></ul> <h3 id="原始指令到自适应指令的转换"><a href="#原始指令到自适应指令的转换" class="header-anchor">#</a> 原始指令到自适应指令的转换</h3> <p>原始指令 <code>LOAD_ATTR</code> 仍然执行原来一样的操作，因此只执行原始指令是没有加速效果的，为了加速，Python 3.11 首先会将其替换成自适应指令 <code>LOAD_ATTR_ADAPTIVE</code>，这一步是在运行时 <code>RESUME</code> 指令做的，这也是 Python 3.11 函数第一条指令总是 <code>RESUME</code> 的原因</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// https://github.com/python/cpython/blob/3.11/Python/ceval.c#L1776-L1779</span>
        <span class="token function">TARGET</span><span class="token punctuation">(</span>RESUME<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">_PyCode_Warmup</span><span class="token punctuation">(</span>frame<span class="token operator">-&gt;</span>f_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">JUMP_TO_INSTRUCTION</span><span class="token punctuation">(</span>RESUME_QUICK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>RESUME</code> 指令会调用 <code>_PyCode_Warmup</code> 增加 warmup 计数器 <code>co_warmup</code></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// https://github.com/python/cpython/blob/3.11/Include/internal/pycore_code.h#L95-L111</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">QUICKENING_WARMUP_DELAY</span> <span class="token expression"><span class="token number">8</span></span></span>
<span class="token comment">/* We want to compare to zero for efficiency, so we offset values accordingly */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">QUICKENING_INITIAL_WARMUP_VALUE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token operator">-</span>QUICKENING_WARMUP_DELAY<span class="token punctuation">)</span></span></span>
<span class="token keyword">void</span> <span class="token function">_PyCode_Quicken</span><span class="token punctuation">(</span>PyCodeObject <span class="token operator">*</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span>
<span class="token function">_PyCode_Warmup</span><span class="token punctuation">(</span>PyCodeObject <span class="token operator">*</span>code<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>code<span class="token operator">-&gt;</span>co_warmup <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        code<span class="token operator">-&gt;</span>co_warmup<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>code<span class="token operator">-&gt;</span>co_warmup <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">_PyCode_Quicken</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>这里 <code>co_warmup</code> 初始值为 <code>QUICKENING_INITIAL_WARMUP_VALUE</code> 即 <code>-8</code>，也就是说在经过 8 次 <code>RESUME</code> 之后，<code>co_warmup</code> 会变为 0，这时候就会调用 <code>_PyCode_Quicken</code> 来进行加速。（这里只是简化说明，实际上不止 <code>RESUME</code> 会调用 <code>_PyCode_Warmup</code>）</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// https://github.com/python/cpython/blob/3.11/Python/specialize.c#L258-L319</span>
<span class="token comment">// Insert adaptive instructions and superinstructions. This cannot fail.</span>
<span class="token keyword">void</span>
<span class="token function">_PyCode_Quicken</span><span class="token punctuation">(</span>PyCodeObject <span class="token operator">*</span>code<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    _Py_QuickenedCount<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> previous_opcode <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    _Py_CODEUNIT <span class="token operator">*</span>instructions <span class="token operator">=</span> <span class="token function">_PyCode_CODE</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">Py_SIZE</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> opcode <span class="token operator">=</span> <span class="token function">_Py_OPCODE</span><span class="token punctuation">(</span>instructions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">uint8_t</span> adaptive_opcode <span class="token operator">=</span> _PyOpcode_Adaptive<span class="token punctuation">[</span>opcode<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>adaptive_opcode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">_Py_SET_OPCODE</span><span class="token punctuation">(</span>instructions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> adaptive_opcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Make sure the adaptive counter is zero:</span>
            <span class="token function">assert</span><span class="token punctuation">(</span>instructions<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            previous_opcode <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            i <span class="token operator">+=</span> _PyOpcode_Caches<span class="token punctuation">[</span>opcode<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>_PyOpcode_Caches<span class="token punctuation">[</span>opcode<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>opcode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> EXTENDED_ARG<span class="token operator">:</span>
                    <span class="token function">_Py_SET_OPCODE</span><span class="token punctuation">(</span>instructions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> EXTENDED_ARG_QUICK<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> JUMP_BACKWARD<span class="token operator">:</span>
                    <span class="token function">_Py_SET_OPCODE</span><span class="token punctuation">(</span>instructions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> JUMP_BACKWARD_QUICK<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> RESUME<span class="token operator">:</span>
                    <span class="token function">_Py_SET_OPCODE</span><span class="token punctuation">(</span>instructions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> RESUME_QUICK<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> LOAD_FAST<span class="token operator">:</span>
                    <span class="token keyword">switch</span><span class="token punctuation">(</span>previous_opcode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">case</span> LOAD_FAST<span class="token operator">:</span>
                            <span class="token function">_Py_SET_OPCODE</span><span class="token punctuation">(</span>instructions<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                           LOAD_FAST__LOAD_FAST<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token keyword">case</span> STORE_FAST<span class="token operator">:</span>
                            <span class="token function">_Py_SET_OPCODE</span><span class="token punctuation">(</span>instructions<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                           STORE_FAST__LOAD_FAST<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token keyword">case</span> LOAD_CONST<span class="token operator">:</span>
                            <span class="token function">_Py_SET_OPCODE</span><span class="token punctuation">(</span>instructions<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                           LOAD_CONST__LOAD_FAST<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> STORE_FAST<span class="token operator">:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>previous_opcode <span class="token operator">==</span> STORE_FAST<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">_Py_SET_OPCODE</span><span class="token punctuation">(</span>instructions<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                       STORE_FAST__STORE_FAST<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> LOAD_CONST<span class="token operator">:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>previous_opcode <span class="token operator">==</span> LOAD_FAST<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">_Py_SET_OPCODE</span><span class="token punctuation">(</span>instructions<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                       LOAD_FAST__LOAD_CONST<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            previous_opcode <span class="token operator">=</span> opcode<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><p>这里算是一个小的「pass」，遍历全部字节码进行了替换：</p> <ul><li>如果该指令是可特化的，则将该指令替换为自适应版本，比如 <code>LOAD_ATTR</code> 将会被原位替换为 <code>LOAD_ATTR_ADAPTIVE</code></li> <li>如果该指令是 <code>EXTENDED_ARG</code>、<code>JUMP_BACKWARD</code>、<code>RESUME</code> 之一，则将其转为相应的 quick 版本，比如 <code>RESUME</code> 将会被原位替换为 <code>RESUME_QUICK</code></li> <li>如果该指令和下一条指令可以 combine 在一起，则这两条指令 combine 成一条超指令（super instruction），比如 <code>LOAD_FAST</code> + <code>LOAD_FAST</code> 将会被原位替换为 <code>LOAD_FAST__LOAD_FAST</code></li></ul> <p>之后解释器再解释执行的就是自适应指令了。</p> <h3 id="自适应指令"><a href="#自适应指令" class="header-anchor">#</a> 自适应指令</h3> <p>仍然以 <code>LOAD_ATTR</code> 为例，其自适应指令 <code>LOAD_ATTR_ADAPTIVE</code> 的实现如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>        <span class="token function">TARGET</span><span class="token punctuation">(</span>LOAD_ATTR_ADAPTIVE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">assert</span><span class="token punctuation">(</span>cframe<span class="token punctuation">.</span>use_tracing <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _PyAttrCache <span class="token operator">*</span>cache <span class="token operator">=</span> <span class="token punctuation">(</span>_PyAttrCache <span class="token operator">*</span><span class="token punctuation">)</span>next_instr<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ADAPTIVE_COUNTER_IS_ZERO</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                PyObject <span class="token operator">*</span>owner <span class="token operator">=</span> <span class="token function">TOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                PyObject <span class="token operator">*</span>name <span class="token operator">=</span> <span class="token function">GETITEM</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> oparg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                next_instr<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_Py_Specialize_LoadAttr</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> next_instr<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    next_instr<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">DISPATCH_SAME_OPARG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">STAT_INC</span><span class="token punctuation">(</span>LOAD_ATTR<span class="token punctuation">,</span> deferred<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">DECREMENT_ADAPTIVE_COUNTER</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">JUMP_TO_INSTRUCTION</span><span class="token punctuation">(</span>LOAD_ATTR<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>这里两个分支分别表示</p> <ul><li>如果自适应计数器减到 0，则尝试调用 <code>_Py_Specialize_LoadAttr</code> 进行特化</li> <li>否则自适应计数器减 1（计数器字段 - 1，而不是整个数值 - 1），然后跳转到原始指令 <code>LOAD_ATTR</code></li></ul> <p>自适应计数器字段与原始状态和特化状态并不相同，它的 16 bit 被分割成了两部分，其中高 12 bit 才是计数器（counter），低 4 bit 为回退指数（backoff exponent）。计数器总是会被初始化为 <span class="vuepress-eq"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mrow><mi>b</mi><mi>a</mi><mi>c</mi><mi>k</mi><mi>o</mi><mi>f</mi><mi>f</mi></mrow></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{backoff} - 1</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.9324379999999999em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">b</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.10764em;">f</span><span class="mord mathdefault mtight" style="margin-right:0.10764em;">f</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span></span>，比如回退指数为 0 时，计数器初始值为 0，回退指数为 3 时，计数器初始值为 7，以此类推。（详见 <a href="https://github.com/python/cpython/blob/3.11/Include/internal/pycore_code.h#L488-L529" target="_blank" rel="noopener noreferrer">cpython 3.11 pycore_code.h<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）</p> <p>下面我们看看 <code>_Py_Specialize_LoadAttr</code> 中实际发生了什么：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// https://github.com/python/cpython/blob/3.11/Python/specialize.c#L655-L755</span>
<span class="token keyword">int</span>
<span class="token function">_Py_Specialize_LoadAttr</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>owner<span class="token punctuation">,</span> _Py_CODEUNIT <span class="token operator">*</span>instr<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>name<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>_PyOpcode_Caches<span class="token punctuation">[</span>LOAD_ATTR<span class="token punctuation">]</span> <span class="token operator">==</span> INLINE_CACHE_ENTRIES_LOAD_ATTR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _PyAttrCache <span class="token operator">*</span>cache <span class="token operator">=</span> <span class="token punctuation">(</span>_PyAttrCache <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>instr <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyModule_CheckExact</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// LOAD_ATTR_MODULE 特化尝试</span>
        <span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">specialize_module_load_attr</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> instr<span class="token punctuation">,</span> name<span class="token punctuation">,</span> LOAD_ATTR<span class="token punctuation">,</span>
                                              LOAD_ATTR_MODULE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">goto</span> success<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    PyTypeObject <span class="token operator">*</span>type <span class="token operator">=</span> <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token operator">-&gt;</span>tp_dict <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyType_Ready</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    PyObject <span class="token operator">*</span>descr<span class="token punctuation">;</span>
    DescriptorClassification kind <span class="token operator">=</span> <span class="token function">analyze_descriptor</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>descr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>kind<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> OVERRIDING<span class="token operator">:</span>
            <span class="token function">SPECIALIZATION_FAIL</span><span class="token punctuation">(</span>LOAD_ATTR<span class="token punctuation">,</span> SPEC_FAIL_ATTR_OVERRIDING_DESCRIPTOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token keyword">case</span> METHOD<span class="token operator">:</span>
            <span class="token function">SPECIALIZATION_FAIL</span><span class="token punctuation">(</span>LOAD_ATTR<span class="token punctuation">,</span> SPEC_FAIL_ATTR_METHOD<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token keyword">case</span> PROPERTY<span class="token operator">:</span>
            <span class="token function">SPECIALIZATION_FAIL</span><span class="token punctuation">(</span>LOAD_ATTR<span class="token punctuation">,</span> SPEC_FAIL_ATTR_PROPERTY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token keyword">case</span> OBJECT_SLOT<span class="token operator">:</span>
        <span class="token punctuation">{</span>
            PyMemberDescrObject <span class="token operator">*</span>member <span class="token operator">=</span> <span class="token punctuation">(</span>PyMemberDescrObject <span class="token operator">*</span><span class="token punctuation">)</span>descr<span class="token punctuation">;</span>
            <span class="token keyword">struct</span> <span class="token class-name">PyMemberDef</span> <span class="token operator">*</span>dmem <span class="token operator">=</span> member<span class="token operator">-&gt;</span>d_member<span class="token punctuation">;</span>
            Py_ssize_t offset <span class="token operator">=</span> dmem<span class="token operator">-&gt;</span>offset<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PyObject_TypeCheck</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> member<span class="token operator">-&gt;</span>d_common<span class="token punctuation">.</span>d_type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">SPECIALIZATION_FAIL</span><span class="token punctuation">(</span>LOAD_ATTR<span class="token punctuation">,</span> SPEC_FAIL_EXPECTED_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dmem<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> PY_AUDIT_READ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">SPECIALIZATION_FAIL</span><span class="token punctuation">(</span>LOAD_ATTR<span class="token punctuation">,</span> SPEC_FAIL_ATTR_AUDITED_SLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span>offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">SPECIALIZATION_FAIL</span><span class="token punctuation">(</span>LOAD_ATTR<span class="token punctuation">,</span> SPEC_FAIL_OUT_OF_RANGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">assert</span><span class="token punctuation">(</span>dmem<span class="token operator">-&gt;</span>type <span class="token operator">==</span> T_OBJECT_EX<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assert</span><span class="token punctuation">(</span>offset <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cache<span class="token operator">-&gt;</span>index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span>offset<span class="token punctuation">;</span>
            <span class="token function">write_u32</span><span class="token punctuation">(</span>cache<span class="token operator">-&gt;</span>version<span class="token punctuation">,</span> type<span class="token operator">-&gt;</span>tp_version_tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 特化 LOAD_ATTR 为 LOAD_ATTR_SLOT</span>
            <span class="token function">_Py_SET_OPCODE</span><span class="token punctuation">(</span><span class="token operator">*</span>instr<span class="token punctuation">,</span> LOAD_ATTR_SLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> success<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> DUNDER_CLASS<span class="token operator">:</span>
        <span class="token punctuation">{</span>
            Py_ssize_t offset <span class="token operator">=</span> <span class="token function">offsetof</span><span class="token punctuation">(</span>PyObject<span class="token punctuation">,</span> ob_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assert</span><span class="token punctuation">(</span>offset <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cache<span class="token operator">-&gt;</span>index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span>offset<span class="token punctuation">;</span>
            <span class="token function">write_u32</span><span class="token punctuation">(</span>cache<span class="token operator">-&gt;</span>version<span class="token punctuation">,</span> type<span class="token operator">-&gt;</span>tp_version_tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 特化 LOAD_ATTR 为 LOAD_ATTR_SLOT</span>
            <span class="token function">_Py_SET_OPCODE</span><span class="token punctuation">(</span><span class="token operator">*</span>instr<span class="token punctuation">,</span> LOAD_ATTR_SLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> success<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> OTHER_SLOT<span class="token operator">:</span>
            <span class="token function">SPECIALIZATION_FAIL</span><span class="token punctuation">(</span>LOAD_ATTR<span class="token punctuation">,</span> SPEC_FAIL_ATTR_NON_OBJECT_SLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token keyword">case</span> MUTABLE<span class="token operator">:</span>
            <span class="token function">SPECIALIZATION_FAIL</span><span class="token punctuation">(</span>LOAD_ATTR<span class="token punctuation">,</span> SPEC_FAIL_ATTR_MUTABLE_CLASS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token keyword">case</span> GETSET_OVERRIDDEN<span class="token operator">:</span>
            <span class="token function">SPECIALIZATION_FAIL</span><span class="token punctuation">(</span>LOAD_ATTR<span class="token punctuation">,</span> SPEC_FAIL_OVERRIDDEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token keyword">case</span> BUILTIN_CLASSMETHOD<span class="token operator">:</span>
        <span class="token keyword">case</span> PYTHON_CLASSMETHOD<span class="token operator">:</span>
        <span class="token keyword">case</span> NON_OVERRIDING<span class="token operator">:</span>
        <span class="token keyword">case</span> NON_DESCRIPTOR<span class="token operator">:</span>
        <span class="token keyword">case</span> ABSENT<span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// LOAD_ATTR_INSTANCE_VALUE 特化尝试</span>
    <span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">specialize_dict_access</span><span class="token punctuation">(</span>
        owner<span class="token punctuation">,</span> instr<span class="token punctuation">,</span> type<span class="token punctuation">,</span> kind<span class="token punctuation">,</span> name<span class="token punctuation">,</span>
        LOAD_ATTR<span class="token punctuation">,</span> LOAD_ATTR_INSTANCE_VALUE<span class="token punctuation">,</span> LOAD_ATTR_WITH_HINT
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> success<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
fail<span class="token operator">:</span>
    <span class="token function">STAT_INC</span><span class="token punctuation">(</span>LOAD_ATTR<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PyErr_Occurred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cache<span class="token operator">-&gt;</span>counter <span class="token operator">=</span> <span class="token function">adaptive_counter_backoff</span><span class="token punctuation">(</span>cache<span class="token operator">-&gt;</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// backoff + 1，根据 backoff 重设 counter</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
success<span class="token operator">:</span>
    <span class="token function">STAT_INC</span><span class="token punctuation">(</span>LOAD_ATTR<span class="token punctuation">,</span> success<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PyErr_Occurred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cache<span class="token operator">-&gt;</span>counter <span class="token operator">=</span> <span class="token function">miss_counter_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// 特化成功，设置特化计数器初始值（53）</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br></div></div><p>这里有几处 <code>_Py_SET_OPCODE</code> 即是特化成功时将当前指令替换为特化指令的逻辑。我们注意一下 <code>fail</code> 和 <code>success</code>，即特化失败和特化成功的返回逻辑：</p> <ul><li>如果发生特化失败，则会将 <code>backoff</code> + 1，并根据其设置计数器的初始值，显然失败次数越多，计数器初始值越大，就越不容易触发特化，从而有效避免了频繁触发特化失败。</li> <li>如果特化成功，此时指令已经被替换成相应的特化指令，此时会将计数器设置为特化计数器初始值 <code>53</code>，该值来源见 <a href="https://github.com/python/cpython/blob/3.11/Python/specialize.c#L321-L332" target="_blank" rel="noopener noreferrer">cpython 3.11 specialize.c - miss_counter_start<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（简单说就是 cpython 团队发现 50 左右是一个合适的值，就在 50 左右找了一个合适的质数）</li></ul> <p>注意从 <code>RESUME</code> warmup 得来的计数器本就是 0，因此自适应指令最开始就会尝试特化，而没有额外的 warmup 过程。而从特化指令发生去优化（de-optimization）退化为自适应指令时，则会设置一个适中的初始值 31（<span class="vuepress-eq"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>5</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^5 - 1</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span></span>，见 <a href="https://github.com/python/cpython/blob/3.11/Include/internal/pycore_code.h#L514-L518" target="_blank" rel="noopener noreferrer">cpython 3.11 pycore_code.h - adaptive_counter_start<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>），以免频繁发生去优化。</p> <h3 id="特化指令的执行逻辑"><a href="#特化指令的执行逻辑" class="header-anchor">#</a> 特化指令的执行逻辑</h3> <p>这里以 <code>LOAD_ATTR_INSTANCE_VALUE</code> 为例看一下特化指令的执行逻辑：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// https://github.com/python/cpython/blob/3.11/Python/ceval.c#L1489</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DEOPT_IF</span><span class="token expression"><span class="token punctuation">(</span>cond<span class="token punctuation">,</span> instname<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cond<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">goto</span> miss<span class="token punctuation">;</span> <span class="token punctuation">}</span></span></span>
<span class="token comment">// https://github.com/python/cpython/blob/3.11/Python/ceval.c#L3496-L3517</span>
        <span class="token function">TARGET</span><span class="token punctuation">(</span>LOAD_ATTR_INSTANCE_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">assert</span><span class="token punctuation">(</span>cframe<span class="token punctuation">.</span>use_tracing <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            PyObject <span class="token operator">*</span>owner <span class="token operator">=</span> <span class="token function">TOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            PyObject <span class="token operator">*</span>res<span class="token punctuation">;</span>
            PyTypeObject <span class="token operator">*</span>tp <span class="token operator">=</span> <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _PyAttrCache <span class="token operator">*</span>cache <span class="token operator">=</span> <span class="token punctuation">(</span>_PyAttrCache <span class="token operator">*</span><span class="token punctuation">)</span>next_instr<span class="token punctuation">;</span>
            <span class="token class-name">uint32_t</span> type_version <span class="token operator">=</span> <span class="token function">read_u32</span><span class="token punctuation">(</span>cache<span class="token operator">-&gt;</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assert</span><span class="token punctuation">(</span>type_version <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">DEOPT_IF</span><span class="token punctuation">(</span>tp<span class="token operator">-&gt;</span>tp_version_tag <span class="token operator">!=</span> type_version<span class="token punctuation">,</span> LOAD_ATTR<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assert</span><span class="token punctuation">(</span>tp<span class="token operator">-&gt;</span>tp_dictoffset <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assert</span><span class="token punctuation">(</span>tp<span class="token operator">-&gt;</span>tp_flags <span class="token operator">&amp;</span> Py_TPFLAGS_MANAGED_DICT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            PyDictValues <span class="token operator">*</span>values <span class="token operator">=</span> <span class="token operator">*</span><span class="token function">_PyObject_ValuesPointer</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">DEOPT_IF</span><span class="token punctuation">(</span>values <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> LOAD_ATTR<span class="token punctuation">)</span><span class="token punctuation">;</span>
            res <span class="token operator">=</span> values<span class="token operator">-&gt;</span>values<span class="token punctuation">[</span>cache<span class="token operator">-&gt;</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">DEOPT_IF</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> LOAD_ATTR<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">STAT_INC</span><span class="token punctuation">(</span>LOAD_ATTR<span class="token punctuation">,</span> hit<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">SET_TOP</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">JUMPBY</span><span class="token punctuation">(</span>INLINE_CACHE_ENTRIES_LOAD_ATTR<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">DISPATCH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment">// https://github.com/python/cpython/blob/3.11/Python/ceval.c#L5701-L5720</span>
<span class="token comment">/* Specialization misses */</span>
miss<span class="token operator">:</span>
    <span class="token punctuation">{</span>
        <span class="token function">STAT_INC</span><span class="token punctuation">(</span>opcode<span class="token punctuation">,</span> miss<span class="token punctuation">)</span><span class="token punctuation">;</span>
        opcode <span class="token operator">=</span> _PyOpcode_Deopt<span class="token punctuation">[</span>opcode<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">STAT_INC</span><span class="token punctuation">(</span>opcode<span class="token punctuation">,</span> miss<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* The counter is always the first cache entry: */</span>
        _Py_CODEUNIT <span class="token operator">*</span>counter <span class="token operator">=</span> <span class="token punctuation">(</span>_Py_CODEUNIT <span class="token operator">*</span><span class="token punctuation">)</span>next_instr<span class="token punctuation">;</span>
        <span class="token operator">*</span>counter <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>counter <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> adaptive_opcode <span class="token operator">=</span> _PyOpcode_Adaptive<span class="token punctuation">[</span>opcode<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">assert</span><span class="token punctuation">(</span>adaptive_opcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">_Py_SET_OPCODE</span><span class="token punctuation">(</span>next_instr<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> adaptive_opcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">STAT_INC</span><span class="token punctuation">(</span>opcode<span class="token punctuation">,</span> deopt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>counter <span class="token operator">=</span> <span class="token function">adaptive_counter_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        next_instr<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token function">DISPATCH_GOTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>这里出现了几次 <code>DEOPT_IF</code>，即去优化逻辑，如果并不满足当前特化逻辑时，将会将计数器 - 1，并执行原始指令。当计数器减到 0 时，会将当前指令替换为自适应指令，并重置计数器为初始值（即上面提到的 31）。</p> <h3 id="指令特化流程回顾"><a href="#指令特化流程回顾" class="header-anchor">#</a> 指令特化流程回顾</h3> <p>至此，整个「原始指令」→「自适应指令」↔「特化指令」的转换关系基本清晰了～现在我们总结回顾下～</p> <p align="center"><img src="/assets/img/specializing-overview.drawio.ebeeb0d5.png" alt="Inline Cache" width="800px"></p> <p>值得注意的是，其中的虚线表示字节码层面不变，只是逻辑上 fallback 到原始指令 / 自适应指令，而实线则是代表字节码发生了原位替换，即图中的「warmup」、「specializing」、「de-optimization」</p> <h2 id="faster-cpython-的未来"><a href="#faster-cpython-的未来" class="header-anchor">#</a> Faster CPython 的未来</h2> <p>PEP 659 为 Faster CPython 做了一个良好的开端，它让我们看到了 CPython 在利用非 JIT 的方式在运行时获得更多的加速，Faster CPython 目前也在做着更多的改进：</p> <ul><li>更多的指令特化，Python 3.12 已经<a href="https://github.com/faster-cpython/ideas/blob/main/3.12/interpreter_definition.md" target="_blank" rel="noopener noreferrer">实现了一个 DSL<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，用来方便实现解释器逻辑（<code>ceval.c</code>），新的解释器逻辑使用 DSL 写在了 <a href="https://github.com/python/cpython/blob/3.12/Python/bytecodes.c" target="_blank" rel="noopener noreferrer">bytecodes.c<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，之后会根据其编译成 <a href="https://github.com/python/cpython/blob/3.12/Python/generated_cases.c.h" target="_blank" rel="noopener noreferrer">generated_cases.c.h<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（就是原来 <code>ceval.c</code> 里的非常大的 switch-case），可以更加方便地编写指令特化、去优化、超指令等逻辑</li> <li>第二层优化器（<a href="https://github.com/faster-cpython/ideas/blob/main/3.12/tier2.md" target="_blank" rel="noopener noreferrer">Tier 2 Optimizer for CPython -- Early design<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>），该提案基于第一层优化器，即本文所述的 PEP 659，本文所述的优化器仅仅会针对单条指令，而 Tier 2 Optimizer 则会考虑更大的优化范围，将会为未来构建 JIT 提供坚实的基础</li> <li>等等……（其他的我暂时还不清楚）</li></ul> <p>那么暂时先这样啦，以后有什么新的有趣的优化再整理～一些关于 Python 3.11 其他改动的适配文档已经在之前整理在了 <a href="https://github.com/PaddlePaddle/PaddleSOT/tree/develop/docs/compat/python311" target="_blank" rel="noopener noreferrer">PaddleSOT/docs/compat/python311<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，有兴趣也可以参考下～</p> <h2 id="references"><a href="#references" class="header-anchor">#</a> References</h2> <ol><li><a href="https://peps.python.org/pep-0659/" target="_blank" rel="noopener noreferrer">PEP 659 – Specializing Adaptive Interpreter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/python/cpython/tree/3.11" target="_blank" rel="noopener noreferrer">CPython 3.11 Source<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/faster-cpython/ideas" target="_blank" rel="noopener noreferrer">Faster CPython Ideas<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://devguide.python.org/internals/interpreter/#" target="_blank" rel="noopener noreferrer">The Bytecode Interpreter (3.11)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/python/cpython/blob/3.11/Python/adaptive.md" target="_blank" rel="noopener noreferrer">Adding or extending a family of adaptive instructions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.youtube.com/watch?v=MipEJ3XzZjU" target="_blank" rel="noopener noreferrer">How we are making Python 3.11 faster (CPython project)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol></div></article> <section class="post-meta main-div" data-v-3c27fa5a><section class="post-date clearfix" data-v-3c27fa5a><span class="create-date" data-v-3c27fa5a>
      发布时间 : 2023-08-27
    </span> <span class="update-date" data-v-3c27fa5a>
      最后修改 : 2023-08-28
    </span></section> <section class="post-links" data-v-3c27fa5a><a href="/posts/2023/04/22/decomposing-torch-dynamo.html" class="post-link" data-v-3c27fa5a>
      上一篇 : 哇，好复杂的 TorchDynamo，我们拆开看看吧～
    </a> <!----></section></section> <!----></div></main> <aside class="aside" data-v-5e296355><div class="info-card main-div" data-v-d24226c8 data-v-5e296355><div class="info-card-header" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/info-bg.webp);" data-v-d24226c8><img src="/avatar.jpg" alt="喵ック" class="info-avatar" data-v-d24226c8></div> <div class="info-card-body" data-v-d24226c8><section class="info-nickname" data-v-d24226c8>
      喵ック
    </section> <section class="info-desc" data-v-d24226c8>可爱是第一驱动力～</section> <section class="info-contact" data-v-d24226c8><section data-v-d24226c8><span title="Beijing, China" data-v-d24226c8 data-v-d24226c8><svg class="icon" style="font-size:1em;" data-v-d24226c8 data-v-d24226c8><title data-v-d24226c8 data-v-d24226c8>Beijing, China</title><use xlink:href="#icon-location" data-v-d24226c8 data-v-d24226c8></use></svg><span class="info-text" data-v-d24226c8 data-v-d24226c8>
          Beijing, China
        </span></span></section> <section data-v-d24226c8><span title="PaddlePaddle" data-v-d24226c8 data-v-d24226c8><svg class="icon" style="font-size:1em;" data-v-d24226c8 data-v-d24226c8><title data-v-d24226c8 data-v-d24226c8>PaddlePaddle</title><use xlink:href="#icon-organization" data-v-d24226c8 data-v-d24226c8></use></svg><span class="info-text" data-v-d24226c8 data-v-d24226c8>
          PaddlePaddle
        </span></span></section> <section data-v-d24226c8><a href="mailto:sigure.qaq@gmail.com" title="sigure.qaq@gmail.com" data-v-d24226c8 data-v-d24226c8><svg class="icon" style="font-size:1em;" data-v-d24226c8 data-v-d24226c8><title data-v-d24226c8 data-v-d24226c8>sigure.qaq@gmail.com</title><use xlink:href="#icon-email" data-v-d24226c8 data-v-d24226c8></use></svg><span class="info-text" data-v-d24226c8 data-v-d24226c8>
          sigure.qaq@gmail.com
        </span></a></section></section></div> <div class="info-card-footer" data-v-d24226c8><section class="info-sns clearfix" data-v-d24226c8><a href="https://github.com/SigureMo" target="_blank" class="sns-link" data-v-d24226c8><span title="GitHub: SigureMo" class="sns-icon" data-v-d24226c8 data-v-d24226c8><svg class="icon" style="font-size:1.5em;" data-v-d24226c8 data-v-d24226c8><title data-v-d24226c8 data-v-d24226c8>GitHub: SigureMo</title><use xlink:href="#icon-github" data-v-d24226c8 data-v-d24226c8></use></svg></span></a></section></div></div> <div class="post-nav-card main-div" style="position:relative;top:0;width:0px;" data-v-5e296355><div class="post-nav-contents"><svg class="icon"><title>book</title><use xlink:href="#icon-book"></use></svg> <span>文章目录</span> <div class="post-nav-toc"><ul><li><a href="/posts/2023/08/27/python311-instruction-specializing.html#faster-cpython-不断加速的-cpython">Faster CPython——不断加速的 CPython</a></li><li><a href="/posts/2023/08/27/python311-instruction-specializing.html#指令特化">指令特化</a></li><li><a href="/posts/2023/08/27/python311-instruction-specializing.html#额外信息的存储-inline-cache">额外信息的存储——Inline Cache</a></li><li><a href="/posts/2023/08/27/python311-instruction-specializing.html#字节码族-特化与自适应">字节码族——特化与自适应</a><ul><li><a href="/posts/2023/08/27/python311-instruction-specializing.html#原始指令到自适应指令的转换">原始指令到自适应指令的转换</a></li><li><a href="/posts/2023/08/27/python311-instruction-specializing.html#自适应指令">自适应指令</a></li><li><a href="/posts/2023/08/27/python311-instruction-specializing.html#特化指令的执行逻辑">特化指令的执行逻辑</a></li><li><a href="/posts/2023/08/27/python311-instruction-specializing.html#指令特化流程回顾">指令特化流程回顾</a></li></ul></li><li><a href="/posts/2023/08/27/python311-instruction-specializing.html#faster-cpython-的未来">Faster CPython 的未来</a></li><li><a href="/posts/2023/08/27/python311-instruction-specializing.html#references">References</a></li></ul></div></div> <!----></div></aside></div> <footer class="footer" data-v-a9a89600><p class="footer-sns-links" data-v-a9a89600><a href="https://github.com/SigureMo" target="_blank" class="sns-link" data-v-a9a89600><span title="GitHub: SigureMo" class="sns-icon" data-v-a9a89600 data-v-a9a89600><svg class="icon" style="font-size:25px;" data-v-a9a89600 data-v-a9a89600><title data-v-a9a89600 data-v-a9a89600>GitHub: SigureMo</title><use xlink:href="#icon-github" data-v-a9a89600 data-v-a9a89600></use></svg></span></a></p> <p class="footer-text" data-v-a9a89600><span data-v-a9a89600>Powered by </span> <a href="https://github.com/vuejs/vuepress" target="_blank" data-v-a9a89600>
      VuePress
    </a> <span data-v-a9a89600> | </span> <a href="https://github.com/meteorlxy/vuepress-theme-meteorlxy" target="_blank" data-v-a9a89600>
        meteorlxy
      </a></p> <p class="footer-text" data-v-a9a89600>Copyright 2018-present <a href="https://github.com/SigureMo" target="_blank">Nyakku</a> | <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA-4.0</a></p></footer></div><div class="global-ui"><!----><!----><!----><canvas id="vuepress-canvas-ribbon"></canvas><canvas id="vuepress-canvas-cursor"></canvas><div></div><div id="goTop" class="hide-cat" data-v-f6babb38></div><APlayer audio="" fixed="true" theme="#b7daff" loop="loop" order="list" preload="metadata" volume="0.7" mutex="true" lrc-type="3" list-max-height="250" storage-name="vuepress-plugin-meting" id="aplayer-fixed"></APlayer></div></div>
    <script src="/assets/js/app.6ffe9626.js" defer></script><script src="/assets/js/7.f870edc6.js" defer></script><script src="/assets/js/34.f5dd158b.js" defer></script><script src="/assets/js/23.f4ab9440.js" defer></script>
  </body>
</html>
